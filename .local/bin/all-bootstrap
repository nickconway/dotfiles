#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

function fail() {
    if [[ -n $NTFY_TOKEN ]]; then
        curl -d "Provisioning failed" https://notifications.$SERVICES_BASE_DOMAIN/notifications -H "Authorization: Bearer ${NTFY_TOKEN}" &>/dev/null
    fi
}

trap fail ERR

ssh-add -L | grep -q "$(cat ~/.ssh/id_ed25519.pub)" || ssh-add ~/.ssh/id_ed25519

cd ~/Git/ansible
git pull &>/dev/null

ansible-run ~/Git/ansible/bootstrap/main.yml "$@"

if [[ -n $NTFY_TOKEN ]]; then
    curl -d "Provisioning complete" https://notifications.$SERVICES_BASE_DOMAIN/notifications -H "Authorization: Bearer ${NTFY_TOKEN}" &>/dev/null
fi
