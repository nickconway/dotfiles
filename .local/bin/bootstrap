#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

function err() {
    if [[ -n ${NTFY_TOKEN:-} ]]; then
        curl -d "Bootstrapping failed on $(uname -n)" https://notifications.$SERVICES_BASE_DOMAIN/notifications -H "Authorization: Bearer ${NTFY_TOKEN}" &>/dev/null
    fi
    exit 1
}

trap err ERR

export PATH=~/bin:~/.local/bin:"$PATH"
cd

touch .hushlogin
mkdir -p ~/.local/bin
curl -sSL https://raw.githubusercontent.com/nickconway/yadm/refs/heads/master/yadm -o ~/.local/bin/yadm

yadm user-config nickconway &>/dev/null

if ! [[ -e ~/.local/share/yadm/nickconway.git ]]; then
    yadm clone https://github.com/nickconway/dotfiles --no-bootstrap
    yadm remote set-url origin git@github.com:nickconway/dotfiles.git --push
    yadm decrypt
    yadm alt
    yadm list -a -d -e | grep '%%template' | make-templates

    [[ -e ~/.config/shell/common/encrypted.sh ]] && SHELL_NAME=bash . ~/.config/shell/common/encrypted.sh
    [[ -e ~/.config/shell/common/environment.sh ]] && SHELL_NAME=bash . ~/.config/shell/common/environment.sh
fi

if command -v termux-reload-settings >/dev/null; then
    apt update -y && apt upgrade -y
    pkg install openssh starship rust termux-api gnupg fzf dnsutils zsh python3 yq imagemagick binutils pass rip bat git-delta fd ripgrep zoxide gh -y
    mkdir -p ~/.zsh
    cd ~/.config/zsh
    [[ -e ~/.config/zsh/zsh-autosuggestions ]] || git clone https://github.com/zsh-users/zsh-autosuggestions
    [[ -e ~/.config/zsh/zsh-completions ]] || git clone https://github.com/zsh-users/zsh-completions
    [[ -e ~/.config/zsh/zsh-syntax-highlighting ]] || git clone https://github.com/zsh-users/zsh-syntax-highlighting
    [[ -e ~/.config/zsh/zsh-defer ]] || git clone https://github.com/romkatv/zsh-defer
    cd ~
    GPG_TTY=$(tty)
    export GPG_TTY
    yadm decrypt
    yadm alt
    yadm list -a -d -e | grep '%%template' | make-templates
    chsh -s zsh
    exit
fi

get-vars env ~/.config/env.example

if [[ $(yadm config --get-all local.class) == "" ]]; then
    get-yadm-classes
fi

if [[ $(uname -n) == "steamdeck" ]]; then
    sudo systemctl enable --now sshd

    if [[ ! -e ~/.local/source/deck-tailscale ]]; then
        git clone https://github.com/tailscale-dev/deck-tailscale.git ~/.local/source/deck-tailscale
        cd ~/.local/source/deck-tailscale
        sudo bash tailscale.sh
    fi
    source /etc/profile.d/tailscale.sh
    sudo tailscale up --ssh --accept-routes --operator="$(whoami)" --qr --advertise-tags=tag:client,tag:server
    sudo tailscale set --auto-update

    distrobox create -n arch -i archlinux
    distrobox enter arch
    exit
fi

if ! command -v python >/dev/null && command -v python3 >/dev/null; then
    ln -s "$(which python3)" ~/.local/bin/python
fi

if ! command -v uv >/dev/null; then
    curl -LsSf https://astral.sh/uv/install.sh | sh
fi

if [[ -e "$XDG_RUNTIME_DIR" ]]; then
    if [ -S "$XDG_RUNTIME_DIR"/agent.sock ]; then
        export SSH_AUTH_SOCK="$XDG_RUNTIME_DIR"/agent.sock
    else
        eval "$(ssh-agent -t 12h -s -a "$XDG_RUNTIME_DIR"/agent.sock)"
    fi
else
    eval "$(ssh-agent)"
fi

mkdir -p ~/Git

if ! [[ -e ~/Git/ansible ]]; then
    git clone https://github.com/nickconway/ansible ~/Git/ansible &>/dev/null
fi

cd ~/Git/ansible
git remote set-url origin git@github.com:nickconway/ansible --push
git pull &>/dev/null

ansible-run -l localhost ~/Git/ansible/bootstrap/main.yml "$@"

if [[ -n $NTFY_TOKEN ]]; then
    curl -d "Bootstrapping complete on $(uname -n)" https://notifications.$SERVICES_BASE_DOMAIN/notifications -H "Authorization: Bearer ${NTFY_TOKEN}" &>/dev/null
fi
