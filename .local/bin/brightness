#!/usr/bin/env bash
set -euo pipefail

ALL=
BRIGHTNESS=
VAL=
CAELESTIA=$(pgrep -f "qs -c caelestia" || echo "")

case ${1:-} in
ALL)
    ALL=true
    shift
    ;;
esac

case ${1:-} in
set)
    VAL="$2"
    ;;

raise)
    VAL="+${2:-1%}"
    ;;

lower)
    VAL="${2:-1%}-"
    ;;

show)
    SHOW=true
    NAME="${2:-}"
    ;;
esac

if [[ -n "$CAELESTIA" ]]; then
    TARGETS="$(caelestia shell brightness list)"

    if [[ -z ${NAME:-} ]]; then
        BRIGHTNESS=$(caelestia shell brightness get)
    else
        BRIGHTNESS=$(caelestia shell brightness getFor $NAME)
    fi

    BRIGHTNESS="$(echo "$BRIGHTNESS * 100" | bc | sed 's/\.00//g')%"
else
    TARGETS="$(brightnessctl -l | grep backlight | awk '{print $2}' | xargs)"

    if [[ -z ${NAME:-} ]]; then
        BRIGHTNESS=$(brightnessctl -m | awk -F ',' '{print $4}')
    else
        BRIGHTNESS=$(brightnessctl -m -d "$2" | awk -F ',' '{print $4}')
    fi

    BRIGHTNESS="$(echo $BRIGHTNESS | rev | cut -c 2- | rev)"
fi

if [[ -n $VAL ]] && [[ $ALL == true ]]; then
    for d in $TARGETS; do
        if [[ -n "$CAELESTIA" ]] && [[ $(caelestia shell brightness getFor $d) != -1 ]]; then
            caelestia shell brightness setFor $d $VAL
        else
            brightnessctl set -d $d $VAL
        fi

        brightness show $d
    done
elif [[ -n $VAL ]]; then
    caelestia shell brightness set $VAL || brightnessctl set $VAL
    brightness show
fi

if [[ -n ${SHOW:-} ]]; then
    if [[ $ALL == true ]]; then
        for d in $TARGETS; do
            brightness show $d
        done
    else
        if [[ -n ${NAME:-} ]]; then
            EXT=" for $NAME"
        fi

        notify-send Brightness "Current brightness${EXT:-}: $BRIGHTNESS" \
            -h string:key:brightness-${NAME:-main} \
            -h int:value:$BRIGHTNESS -e
    fi
fi
