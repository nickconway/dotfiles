#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

ALL=
BRIGHTNESS=
VAL=
CAELESTIA=$(pgrep -afx "qs .*caelestia.*" || echo "")
NOCTALIA=$(pgrep -afx "qs .*noctalia.*" || echo "")

case ${1:-} in
ALL)
    ALL=true
    shift
    ;;
esac

case ${1:-} in
set)
    VAL="$2"
    ;;

raise)
    VAL="+${2:-1%}"
    ;;

lower)
    VAL="${2:-1%}-"
    ;;

show)
    SHOW=true
    NAME="${2:-}"
    ;;
esac

if [[ -n "$CAELESTIA" ]]; then
    TARGETS="$(qs -c caelestia ipc call brightness list)"

    if [[ -z ${NAME:-} ]]; then
        BRIGHTNESS=$(qs -c caelestia ipc call brightness get)
    else
        BRIGHTNESS=$(qs -c caelestia ipc call brightness getFor $NAME)
    fi

    BRIGHTNESS="$(echo "$BRIGHTNESS * 100" | bc | sed 's/\.00//g')%"
elif [[ -n "$NOCTALIA" ]]; then
    TARGETS="$(hyprctl monitors -j | jq '.[].name' | xargs)"
else
    TARGETS="$(brightnessctl -l | grep backlight | awk '{print $2}' | xargs)"

    if [[ -z ${NAME:-} ]]; then
        BRIGHTNESS=$(brightnessctl -m | awk -F ',' '{print $4}')
    else
        BRIGHTNESS=$(brightnessctl -m -d "$2" | awk -F ',' '{print $4}')
    fi

    BRIGHTNESS="$(echo $BRIGHTNESS | rev | cut -c 2- | rev)"
fi

if [[ -n $VAL ]] && [[ $ALL == true ]]; then
    for d in $TARGETS; do
        if [[ -n "$CAELESTIA" ]] && [[ $(qs -c caelestia ipc call brightness getFor $d) != -1 ]]; then
            qs -c caelestia ipc call brightness setFor $d $VAL
        elif [[ -n "$NOCTALIA" ]]; then
            qs -c noctalia ipc call brightness set $VAL
        else
            brightnessctl set -d $d $VAL
        fi

        brightness show $d
    done
elif [[ -n $VAL ]]; then
    if [[ -n "$CAELESTIA" ]]; then
        qs -c caelestia ipc call brightness set $VAL
    elif [[ -n "$NOCTALIA" ]] && [[ $VAL == +* ]]; then
        qs -c noctalia ipc call brightness increase
    elif [[ -n "$NOCTALIA" ]] && [[ $VAL == *- ]]; then
        qs -c noctalia ipc call brightness decrease
    else
        brightnessctl set $VAL
    fi
    brightness show
fi

if [[ -n ${SHOW:-} ]]; then
    if [[ $ALL == true ]]; then
        for d in $TARGETS; do
            brightness show $d
        done
    else
        if [[ -n ${NAME:-} ]]; then
            EXT=" for $NAME"
        fi

        notify-send Brightness "Current brightness${EXT:-}: $BRIGHTNESS" \
            -h string:synchronous:brightness-${NAME:-main} \
            -h int:value:$BRIGHTNESS -e
    fi
fi
