#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

function _cp() {
    local DIR
    DIR="$(dirname "${@: -1}")"
    mkdir -p "$DIR" || sudo mkdir -p "$DIR"
    cp "${@}" &>/dev/null || sudo cp "${@}"
}

export YAZI_CONFIG_HOME=~/.config/yazi/wal

reload='false'
random='false'
light='false'
eight='false'

METHOD=lighten

while getopts 'lm:rR8' flag; do
    case "${flag}" in
    l) light=true ;;
    m) METHOD="$OPTARG" ;;
    r) random=true ;;
    R) reload=true ;;
    8) eight=true ;;
    *) ;;
    esac
done

if [[ "$reload" == "true" ]]; then
    INPUT="$(cat ~/.cache/wal/wal)"
elif [[ "$random" == "true" ]]; then
    INPUT="$WALLPAPER_DIR"
else
    INPUT="$(echo >/tmp/wallpaper && cd "$WALLPAPER_DIR" && yazi --chooser-file /tmp/wallpaper && cat /tmp/wallpaper)"
fi

WAL_CMD=(uvx --with colorthief --with colorz --with haishoku --from pywal16 wal -q -i "$INPUT")

if [[ "$eight" == false ]]; then
    WAL_CMD+=(--cols16 "${METHOD:-lighten}")
fi

if [[ $light == true ]]; then
    WAL_CMD+=(-l)
fi

if command -v gum &>/dev/null; then
    gum spin --title "Generating colors" -- "${WAL_CMD[@]}"
else
    "${WAL_CMD[@]}"
fi

IMG="$(cat ~/.cache/wal/wal)"
kitten icat "$IMG" || true

_cp "$IMG" ~/.config/wallpaper
_cp ~/.config/wallpaper{,.png}

magick "$IMG" -strip -resize 1000 -gravity center -extent 1000 -quality 90 ~/.cache/wal/wal.thmb

magick "$IMG" -strip -thumbnail 500x500^ -gravity center -extent 500x500 ~/.cache/wal/wal.sqre
magick "$IMG" -strip -scale 10% -blur 0x3 -resize 100% ~/.cache/wal/wal.blur
magick ~/.cache/wal/wal.sqre \( -size 500x500 xc:white -fill "rgba(0,0,0,0.7)" -draw "polygon 400,500 500,500 500,0 450,0" -fill black -draw "polygon 500,500 500,0 450,500" \) -alpha Off -compose CopyOpacity -composite ~/.cache/wal/wal.png
mv ~/.cache/wal/wal.png ~/.cache/wal/wal.quad

if [[ $light == true ]]; then
    gsettings set org.gnome.desktop.interface color-scheme "prefer-light" || true
else
    gsettings set org.gnome.desktop.interface color-scheme "prefer-dark" || true
fi

_cp ~/.cache/wal/gradience.json ~/.config/presets/user/pywal.json

_cp ~/.cache/wal/pywal.kvconfig ~/.config/Kvantum/pywal/pywal.kvconfig
_cp ~/.cache/wal/pywal.svg ~/.config/Kvantum/pywal/pywal.svg
kvantummanager --set pywal || true

_cp ~/.cache/wal/colors-k9s.yaml ~/.config/k9s/skins/wal.yaml

_cp "$IMG" /usr/share/sddm/themes/sugar-candy/Backgrounds/bg.png
_cp ~/.cache/wal/sugar-candy.conf /usr/share/sddm/themes/sugar-candy/theme.conf

_cp "$IMG" /usr/share/sddm/themes/ltmnight/Backgrounds/bg.png
_cp ~/.cache/wal/hyprltm.conf /usr/share/sddm/themes/ltmnight/Themes/hyprltm.cof

_cp ~/.config/wal/templates/colors-gtk.css ~/.config/gtk-3.0/gtk.css
_cp ~/.config/wal/templates/colors-gtk.css ~/.config/gtk-4.0/gtk.css

_cp ~/.cache/wal/vesktop.css ~/.var/app/dev.vencord.Vesktop/config/vesktop/themes/pywal.theme.css

echo "\$WALLPAPER = ~/.config/wallpaper.png" >~/.config/hypr/include/wallpaper.conf

hyprctl hyprpaper wallpaper ", ~/.config/wallpaper.png, " &>/dev/null || true

_cp ~/.cache/wal/colors-noctalia.json ~/.config/noctalia/colorschemes/PyWal/PyWal.json
_cp ~/.cache/wal/colors-noctalia.json ~/.config/noctalia/colors.json
for m in $(hyprctl monitors -j | jq '.[].name' | xargs); do
    qs -c noctalia ipc call wallpaper set ~/.config/wallpaper.png $m || true
done

qs -c dms ipc call wallpaper set ~/.config/wallpaper.png || true

_cp ~/.cache/wal/caelestia-schema.json ~/.local/state/caelestia/scheme.json
caelestia wallpaper -N -f ~/.config/wallpaper.png &>/dev/null || true

timeout 1 swaync-client -rs &>/dev/null || true

gcc ~/.config/darkreader/pywal.c -o ~/.config/darkreader/pywal

fastfetch
eval "$(notify-send -e -h string:synchronous:theme -i "$IMG" "Theme" "Theme changed" --action "$0=Pick" --action "$0 -r=Random" --action "$0  -R=Reload")"
