#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

function _cd() {
    local DIR

    if [[ -d "$1" ]]; then
        DIR="$1"
    else
        DIR="$(docker inspect "$1" | jq -r '.[].Config.Labels["com.docker.compose.project.working_dir"]')"
    fi

    cd "$DIR"
}

function start() {
    if grep -q '\- proxy$' "$DOCKER_STACK_DIR" 2>/dev/null; then
        docker network inspect proxy &>/dev/null || docker network create proxy
    fi

    _cd "$1"

    if [[ -e setup ]]; then
        ./setup
    fi

    docker compose up -d --build
}

function stop() {
    _cd "$1"
    docker compose stop
}

function update() {
    _cd "$1"
    docker compose pull
    docker compose up -d --build
}

function dump() {
    CONTAINER=$1
    cd "$(docker inspect "$CONTAINER" | jq -r '.[].Config.Labels["com.docker.compose.project.working_dir"]')"

    if docker exec "$CONTAINER" bash -c 'which pg_dumpall && [[ -n $POSTGRES_USER ]]' &>/dev/null; then
        echo "Dumping postgres container $CONTAINER"
        docker exec "$CONTAINER" bash -c 'pg_dumpall -c --if-exists --username "$POSTGRES_USER"' >data/dump.sql
    elif docker exec "$CONTAINER" bash -c 'which mysqldump && [[ -n $MYSQL_USER ]]' &>/dev/null; then
        echo "Dumping mysql container $CONTAINER"
        docker exec "$CONTAINER" bash -c 'mysqldump -u "$MYSQL_USER" --password="$MYSQL_PASSWORD" --all-databases --no-tablespaces' >data/dump.sql
    elif docker exec "$CONTAINER" bash -c 'which mariadb-dump && [[ -n $MARIADB_USER ]]' &>/dev/null; then
        echo "Dumping mariadb container $CONTAINER"
        # docker exec "$c" bash -c 'mariadb-dump -u"$MARIADB_USER" -p"$MARIADB_PASSWORD" --all-databases --no-tablespaces' > data/dump.sql
    elif docker exec "$CONTAINER" bash -c 'which mongodump' &>/dev/null; then
        echo "Dumping mongo container $CONTAINER"
        docker exec "$CONTAINER" mongodump --archive >data/mongo.dump
    fi
}

function restore() {
    CONTAINER=$1
    cd "$(docker inspect "$CONTAINER" | jq -r '.[].Config.Labels["com.docker.compose.project.working_dir"]')"

    if docker exec "$CONTAINER" bash -c 'which psql && [[ -n $POSTGRES_USER ]]' &>/dev/null; then
        echo "Restoring postgres container $CONTAINER"
        docker exec -i "$CONTAINER" bash -c 'psql -U "$POSTGRES_USER"' <data/dump.sql >/dev/null
    elif docker exec "$CONTAINER" bash -c 'which mysql && [[ -n $MYSQL_USER ]]' &>/dev/null; then
        echo "Restoring mysql container $CONTAINER"
        docker exec -i "$CONTAINER" bash -c 'mysql -u "$MYSQL_USER" --password="$MYSQL_PASSWORD"' <data/dump.sql >/dev/null
    elif docker exec "$CONTAINER" bash -c 'which mariadb && [[ -n $MARIADB_USER ]]' &>/dev/null; then
        echo "Restoring mariadb container $CONTAINER"
        docker exec -i "$CONTAINER" bash -c 'mariadb -u"$MARIADB_USER" -p"$MARIADB_PASSWORD"' <data/dump.sql >/dev/null
    elif docker exec "$CONTAINER" bash -c 'which mongodump' &>/dev/null; then
        echo "Restoring mongo container $CONTAINER"
        docker exec -i "$CONTAINER" mongorestore --archive <data/mongo.dump >/dev/null
    fi
}

function unhealthy() {
    docker ps --format=json | jq -r '{Names, State, Status} | select((.State != "running") or (.Status | contains("unhealthy"))) | .Names'
}

export -f _cd start stop update dump restore

cd "${DOCKER_STACK_DIR:-"$HOME/Docker"}"
CMD="$1"
shift

TARGETS=()

if [[ -p /dev/stdin ]]; then
    readarray -t TARGETS
fi

if [[ -n "$*" ]]; then
    TARGETS+=("${@}")
fi

if [[ $CMD == dump ]] || [[ $CMD == restore ]]; then
    readarray -t TARGETS < <(docker ps --format '{{.Names}}' | grep -v nextcloud-aio)
fi

if [[ -z "${TARGETS:-}" ]]; then
    TARGETS+=(*)
fi

if [[ $CMD == unhealthy ]]; then
    $CMD
    exit
fi

run "$CMD \$D" "${TARGETS[@]}"

if docker ps | grep -q nextcloud-aio-mastercontainer; then
    if [[ $CMD == start ]]; then
        docker exec -it nextcloud-aio-mastercontainer sudo -u www-data php /var/www/docker-aio/php/src/Cron/StartContainers.php
    elif [[ $CMD == stop ]]; then
        docker exec -it nextcloud-aio-mastercontainer sudo -u www-data php /var/www/docker-aio/php/src/Cron/StopContainers.php
    fi
fi

if [[ $CMD == start ]] || [[ $CMD == stop ]]; then
    readarray -t CONTAINERS < <(docker ps -a --format '{{ .Names }}' | grep -v nextcloud-aio)
    docker "$CMD" "${CONTAINERS[@]}" &>/dev/null
fi
