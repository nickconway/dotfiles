#!/usr/bin/env bash
set -euo pipefail

docker ps --format '{{.Names}}' | grep -v nextcloud-aio | while read -r c; do
    DIR="$(docker inspect "$c" | jq -r '.[].Config.Labels["com.docker.compose.project.working_dir"]')"
    cd "$DIR"

    if [[ $# -gt 0 ]]; then
        SKIP=true
        for a in "$@"; do
            if [[ "$a" == "$c" ]]; then
                SKIP=false
            fi
        done

        if [[ "$SKIP" == true ]]; then
            continue
        fi
    fi

    if docker exec "$c" bash -c 'which pg_dumpall && [[ -n $POSTGRES_USER ]]' &>/dev/null; then
        echo "Dumping postgres container $c"
        docker exec "$c" bash -c 'pg_dumpall -c --if-exists --username "$POSTGRES_USER"' > data/dump.sql
    elif docker exec "$c" bash -c 'which mysqldump && [[ -n $MYSQL_USER ]]' &>/dev/null; then
        echo "Dumping mysql container $c"
        docker exec "$c" bash -c 'mysqldump -u "$MYSQL_USER" --password="$MYSQL_PASSWORD" --all-databases --no-tablespaces' > data/dump.sql
    elif docker exec "$c" bash -c 'which mariadb-dump && [[ -n $MARIADB_USER ]]' &>/dev/null; then
        echo "Dumping mariadb container $c"
        docker exec "$c" bash -c 'mariadb-dump -u"$MARIADB_USER" -p"$MARIADB_PASSWORD" --all-databases --no-tablespaces' > data/dump.sql
    elif docker exec "$c" bash -c 'which mongodump' &>/dev/null; then
        echo "Dumping mongo container $c"
        docker exec "$c" mongodump --archive > data/mongo.dump
    fi
done
