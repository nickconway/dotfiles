#!/usr/bin/env bash
set -euo pipefail

NAS_DIR="/mnt/nas/home/Documents/Emulation"
EMUDECK_DIR="$(jq -r '.storagePath' .config/EmuDeck/settings.json)/Emulation"

RSYNC_CMD="rsync -Lauvz --progress --info=progress2"

function pull-saves() {
    echo "Pulling Saves"
    $RSYNC_CMD "$NAS_DIR"/Saves/ "$EMUDECK_DIR/saves"
}

function push-saves() {
    echo "Pushing Saves"
    $RSYNC_CMD "$EMUDECK_DIR/saves/" "$NAS_DIR"/Saves
}

function sync-saves() {
    pull-saves
    echo
    push-saves
}

function pull-games() {
    echo "Pulling Games"
    $RSYNC_CMD "$NAS_DIR"/Games/ "$EMUDECK_DIR/roms"
}

function push-games() {
    echo "Pushing Games"
    $RSYNC_CMD "$EMUDECK_DIR/roms/" "$NAS_DIR"/Games
}

function link-games() {
    if [[ -e "$EMUDECK_DIR/roms" ]] && [[ ! -L "$EMUDECK_DIR/roms" ]]; then
        mv "$EMUDECK_DIR"/roms{,-bkp}
    fi

    if [[ ! -e "$EMUDECK_DIR/roms" ]]; then
        ln -sf "$NAS_DIR"/Games "$EMUDECK_DIR/roms"
    fi
}

function sync-games() {
    pull-games
    echo
    push-games
}

function pull-bios() {
    echo "Pulling BIOS"
    $RSYNC_CMD "$NAS_DIR"/BIOS/ "$EMUDECK_DIR/bios"
}

function push-bios() {
    echo "Pushing BIOS"
    $RSYNC_CMD "$EMUDECK_DIR/bios/" "$NAS_DIR"/BIOS
}

function sync-bios() {
    pull-bios
    echo
    push-bios
}

if [[ $# == 0 ]]; then
    sync-games
    echo
    sync-saves
    echo
    sync-bios
elif [[ $# -eq 1 && "${1:-}" == "pull" ]]; then
    pull-games
    echo
    pull-saves
    echo
    pull-bios
elif [[ $# -eq 1 && "${1:-}" == "push" ]]; then
    push-games
    echo
    push-saves
    echo
    push-bios
else
    for arg in "${@:2}"; do
        "$1"-"$arg"
        echo
    done
fi
