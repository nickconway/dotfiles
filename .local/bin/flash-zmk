#!/usr/bin/env bash
set -euo pipefail

function clean() {
    if [[ -e tmp ]]; then
        sudo umount tmp
        rmdir tmp
    fi
}
trap clean ERR EXIT

enable_logging=false

while getopts 'flps:u' flag; do
    case "${flag}" in
    l) enable_logging=true ;;
    p) passthrough=true ;;
    s) log_search="$OPTARG" ;;
    *) continue ;;
    esac
done
shift $((OPTIND - 1))

OLD_BASE="$1"

BASE="$OLD_BASE"
BASE="${BASE%_left}"
BASE="${BASE%_right}"

IS_SPLIT=false
if [[ $(find ~/Git/zmk{,-config} -name ${BASE}_left.conf | wc -l) -gt 0 ]]; then
    IS_SPLIT=true
fi

if [[ "$IS_SPLIT" == true ]]; then
    if [[ "$OLD_BASE" == "$BASE" ]] || [[ "$OLD_BASE" == *"_right" ]]; then
        mkdir -p tmp

        echo "Set right keyboard to flashing mode..."
        while [[ ! -e /dev/disk/by-label/NICENANO ]]; do
            true
        done
        echo "Flashing..."
        sudo mount /dev/disk/by-label/NICENANO tmp
        sudo cp ~/Git/zmk/app/build/$BASE/right/zephyr/zmk.uf2 tmp
        while [[ -e /dev/disk/by-label/NICENANO ]]; do
            true
        done
        echo "Flashing complete"

        clean
    fi

    if [[ "$OLD_BASE" == "$BASE" ]] || [[ "$OLD_BASE" == *"_left" ]]; then
        mkdir -p tmp

        echo "Set left keyboard to flashing mode..."
        while [[ ! -e /dev/disk/by-label/NICENANO ]]; do
            true
        done
        echo "Flashing..."
        sudo mount /dev/disk/by-label/NICENANO tmp
        sudo cp ~/Git/zmk/app/build/$BASE/left/zephyr/zmk.uf2 tmp
        while [[ -e /dev/disk/by-label/NICENANO ]]; do
            true
        done
        echo "Flashing complete"

        clean
    fi
else
    mkdir -p tmp

    echo "Set keyboard to flashing mode..."
    while [[ ! -e /dev/disk/by-label/NICENANO ]]; do
        true
    done
    echo "Flashing..."
    sudo mount /dev/disk/by-label/NICENANO tmp
    sudo cp ~/Git/zmk/app/build/$BASE/zmk.uf2 tmp
    while [[ -e /dev/disk/by-label/NICENANO ]]; do
        true
    done
    echo "Flashing complete"

    clean
fi

clean

if [[ $enable_logging == true ]]; then
    LOG_FLAGS=""

    if [[ -n "${log_search:-}" ]]; then
        LOG_FLAGS+=" -s $log_search"
    fi

    if [[ ${passthrough:-} == true ]]; then
        LOG_FLAGS+=" -p"
    fi

    log-zmk $LOG_FLAGS
fi
