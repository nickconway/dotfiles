#!/usr/bin/env bash

[[ -n $NTFY_TOKEN ]]

UPDATES="$(dockcheck -n | awk "x==1 {print} /Containers with updates available:/,EOF {x=1}" | grep -v 'nextcloud-aio' | grep -v "No updates installed" | awk NF)"
UPDATES="${UPDATES//$'\n'/ }"
UPDATES="${UPDATES// /, }"

if [[ -n "$UPDATES" ]]; then
    echo "$UPDATES"
    curl -H "Title: Docker updates available on $(uname -n)" \
        https://notifications.conway.dev/docker \
        -H 'Content-Type: application/json' \
        -H "Authorization: Bearer ${NTFY_TOKEN}" \
        -d "The following have updates available: $UPDATES" \
        -H "Actions: http, Update Now, https://run.conway.dev/api/StartActionAndWait, method=POST, clear=true, body='{ \"actionId\": \"updateContainers\", \"arguments\": [{ \"name\": \"hostname\", \"value\": \"$(uname -n)\" }] }'"
fi
