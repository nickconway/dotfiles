#!/usr/bin/env bash
set -euo pipefail

FILE=${1:-env.example}
OUTPUT=${2:-.env}

[[ -e "$FILE" ]] || exit 0

function get-input() {
    PROMPT=${1:-"Enter a value for $VAR"}

    if command -v gum &>/dev/null; then
        gum input --header "$PROMPT" --placeholder "$PLACEHOLDER" </dev/tty
    else
        read -r -p "$PROMPT: " </dev/tty
        echo $REPLY
    fi
}

while read -r LINE; do
    if [[ -z "$LINE" ]]; then continue; fi

    STATEMENT="$(echo "$LINE" | cut -d '=' -f 1)"
    VAR="$(echo "$STATEMENT" | awk '{ print $NF }')"
    PLACEHOLDER="$(echo "$LINE" | cut -d '=' -f 2- | envsubst | xargs)"

    if ! grep -q "^$STATEMENT=" "$OUTPUT" &>/dev/null || false; then
        if env | grep -q "^$VAR="; then
            INPUT="$(env | (grep "^$VAR=" || true) | cut -d '=' -f 2-)"
        else
            INPUT="$(get-input)"
            INPUT="${INPUT:-$PLACEHOLDER}"
        fi
        echo "$STATEMENT=\"$INPUT\""
    fi
done <"$FILE"
