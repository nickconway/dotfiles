#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
    export DEBUG_MODE
fi

function get-input() {
    local PROMPT=${1:-"Enter a value for $VAR"}
    local PLACEHOLDER=$(eval echo ${PLACEHOLDER})
    local INPUT

    if command -v gum &>/dev/null; then
        INPUT="$(gum input --header "$PROMPT" --placeholder "$PLACEHOLDER" </dev/tty)"
    else
        read -r -p "$PROMPT: " INPUT </dev/tty
    fi

    INPUT="${INPUT:-$PLACEHOLDER}"
    eval "echo $INPUT"
}

case $1 in
env)
    FILE=${2:-env.example}
    OUTPUT=${3:-.env}
    ;;

terraform)
    FILE=${2:-variable.tf}
    OUTPUT=${3:-terraform.tfvars}
    ;;
esac

touch "$OUTPUT"
[[ -e "$FILE" ]] || exit 0

case $1 in
env)
    while read -r LINE; do
        if [[ -z "$LINE" ]]; then
            continue
        fi

        STATEMENT="$(echo "$LINE" | cut -d '=' -f 1)"
        VAR="$(echo "$STATEMENT" | awk '{ print $NF }')"
        PLACEHOLDER="$(echo "$LINE" | cut -d '=' -f 2- | envsubst | xargs)"

        if ! grep -q "^$STATEMENT=" "$OUTPUT" &>/dev/null || false; then
            if env | grep -q "^$VAR="; then
                INPUT="$(env | (grep "^$VAR=" || true) | cut -d '=' -f 2-)"
            else
                INPUT="$(get-input)"
                INPUT="${INPUT:-$PLACEHOLDER}"
                INPUT="$(eval "echo $INPUT")"
            fi
            eval "$STATEMENT=\"$INPUT\""
            echo "$STATEMENT=\"$INPUT\"" >>"$OUTPUT"
        fi
    done <"$FILE"
    ;;

terraform)
    while read -r LINE; do
        VAR=$(echo "$LINE" | awk '{print $2}')
        DEFAULT=$(echo var."$VAR" | tofu console)
        PLACEHOLDER=$(echo "$DEFAULT" | xargs)

        if grep -q "^$VAR =" "$OUTPUT"; then
            continue
        fi

        INPUT="$(get-input)"
        INPUT="${INPUT:-$PLACEHOLDER}"

        if [[ $DEFAULT = '"'*'"' ]]; then
            INPUT="\"$INPUT\""
        fi

        echo "$VAR = $INPUT" >>"$OUTPUT"
    done < <(grep '^variable' "$FILE")
    ;;
esac
