#!/usr/bin/env bash
set -euo pipefail

function get-input() {
    PROMPT=${1:-"Enter a value for $VAR"}

    if command -v gum &>/dev/null; then
        gum input --header "$PROMPT" --placeholder "$PLACEHOLDER" </dev/tty
    else
        read -r -p "$PROMPT: " </dev/tty
        echo $REPLY
    fi
}

case $1 in
env)
    FILE=${2:-env.example}
    OUTPUT=${3:-.env}
    ;;

terraform)
    FILE=${2:-variable.tf}
    OUTPUT=${3:-terraform.tfvars}
    ;;
esac

[[ -e "$FILE" ]] || exit 0

case $1 in
env)
    while read -r LINE; do
        if [[ -z "$LINE" ]]; then
            continue
        fi

        STATEMENT="$(echo "$LINE" | cut -d '=' -f 1)"
        VAR="$(echo "$STATEMENT" | awk '{ print $NF }')"
        PLACEHOLDER="$(echo "$LINE" | cut -d '=' -f 2- | envsubst | xargs)"

        if ! grep -q "^$STATEMENT=" "$OUTPUT" &>/dev/null || false; then
            if env | grep -q "^$VAR="; then
                INPUT="$(env | (grep "^$VAR=" || true) | cut -d '=' -f 2-)"
            else
                INPUT="$(get-input)"
                INPUT="${INPUT:-$PLACEHOLDER}"
            fi
            eval "$STATEMENT=\"$INPUT\""
            echo "$STATEMENT=\"$INPUT\"" >>"$OUTPUT"
        fi
    done <"$FILE"
    ;;

terraform)
    while read -r LINE; do
        VAR=$(echo "$LINE" | awk '{print $2}')
        DEFAULT=$(echo var."$VAR" | tofu console)
        PLACEHOLDER=$(echo "$DEFAULT" | xargs)

        if ! grep -q "^$VAR =" terraform.tfvars; then
            continue
        fi

        INPUT="$(get-input)"
        INPUT="${INPUT:-$PLACEHOLDER}"

        if [[ $DEFAULT = '"'*'"' ]]; then
            INPUT="\"$INPUT\""
        fi

        echo "$VAR = $INPUT" >>"$OUTPUT"
    done < <(grep '^variable' "$FILE")
    ;;
esac
