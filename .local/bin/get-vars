#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

function clean() {
    if [[ "${ENCRYPTED:-}" == true ]]; then
        if ansible-vault-password &>/dev/null; then
            ansible-vault encrypt "$OUTPUT" --vault-id ~/.local/bin/ansible-vault-password >/dev/null
        else
            ansible-vault encrypt "$OUTPUT" --ask-vault-pass >/dev/null
        fi
    fi
}

trap clean ERR EXIT

function get-input() {
    local PROMPT=${1:-"Enter a value for $VAR"}
    PLACEHOLDER=$(eval echo ${PLACEHOLDER})

    if command -v gum &>/dev/null; then
        INPUT="$(gum input --header "$PROMPT" --placeholder "$PLACEHOLDER" </dev/tty)" || return 1
    else
        read -r -p "$PROMPT (default '$PLACEHOLDER'): " INPUT </dev/tty
    fi

    INPUT="${INPUT:-$PLACEHOLDER}"
    INPUT="$(eval "echo $INPUT")"
}

case $1 in
env)
    FILE=${2:-env.example}
    OUTPUT=${3:-.env}
    ;;

terraform)
    FILE=${2:-variable.tf}
    OUTPUT=${3:-terraform.tfvars}
    ;;

ansible)
    FILE=${2:-vars.example.yml}
    OUTPUT=${3:-vars.yml}
    ;;
esac

touch "$OUTPUT"
[[ -e "$FILE" ]] || exit 0

case $1 in
env)
    while read -r LINE; do
        if [[ -z "$LINE" ]]; then
            continue
        fi

        STATEMENT="$(echo "$LINE" | cut -d '=' -f 1)"
        VAR="$(echo "$STATEMENT" | awk '{ print $NF }')"
        PLACEHOLDER="$(echo "$LINE" | cut -d '=' -f 2- | envsubst | xargs)"

        if ! grep -q "^$STATEMENT=" "$OUTPUT" &>/dev/null || false; then
            if env | grep -q "^$VAR="; then
                INPUT="$(env | (grep "^$VAR=" || true) | cut -d '=' -f 2-)"
            else
                get-input || continue
            fi

            eval "$STATEMENT=\"$INPUT\""
            echo "$STATEMENT=\"$INPUT\"" >>"$OUTPUT"
        fi
    done <"$FILE"
    ;;

terraform)
    while read -r LINE; do
        VAR=$(echo "$LINE" | awk '{print $2}')
        DEFAULT=$(echo var."$VAR" | tofu console)
        PLACEHOLDER=$(echo "$DEFAULT" | xargs)

        if grep -q "^$VAR =" "$OUTPUT"; then
            continue
        fi

        get-input || continue

        if [[ "$DEFAULT" == '"'*'"' ]]; then
            INPUT="\"$INPUT\""
        fi

        echo "$VAR = $INPUT" >>"$OUTPUT"
    done < <(grep '^variable' "$FILE")
    ;;

ansible)
    if grep -q "^\$ANSIBLE_VAULT" "$OUTPUT"; then
        ENCRYPTED=true
        if ansible-vault-password &>/dev/null; then
            ansible-vault decrypt "$OUTPUT" --vault-id ~/.local/bin/ansible-vault-password >/dev/null
        else
            ansible-vault decrypt "$OUTPUT" --ask-vault-pass >/dev/null
        fi
    fi

    while read -r LINE; do
        if [[ -z "$LINE" ]]; then
            continue
        fi

        VAR=$(echo "$LINE" | cut -d ':' -f 1)
        DEFAULT=$(echo "$LINE" | cut -d ':' -f 2-)
        PLACEHOLDER="$DEFAULT"

        if grep -q "^$VAR:" "$OUTPUT"; then
            continue
        fi

        get-input || continue

        if [[ "$DEFAULT" =~ '"'*'"' ]]; then
            INPUT="\"$INPUT\""
        fi

        echo "$VAR: $INPUT" >>"$OUTPUT"
    done <"$FILE"
    ;;
esac
