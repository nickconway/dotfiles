#!/usr/bin/env bash

function clockwise() {
    x=$1
    y=$2
    r=${3:-1}

    for ((i = 0; i < r; i++)); do
        tmp=$x
        x=$y
        y=$((-1 * tmp))
    done

    echo $x $y
}

function rotate() {
    ORIENTATION="$1"

    if [[ "$ORIENTATION" == normal ]]; then
        TRANSFORM=0
    elif [[ "$ORIENTATION" == left-up ]]; then
        TRANSFORM=1
    elif [[ "$ORIENTATION" == bottom-up ]]; then
        TRANSFORM=2
    elif [[ "$ORIENTATION" == right-up ]]; then
        TRANSFORM=3
    fi

    ROTATIONS=0

    case $LAST_ORIENTATION in
    normal)
        case $ORIENTATION in
        left-up) ROTATIONS=1 ;;
        bottom-up) ROTATIONS=2 ;;
        right-up) ROTATIONS=3 ;;
        esac
        ;;

    left-up)
        case $ORIENTATION in
        bottom-up) ROTATIONS=1 ;;
        right-up) ROTATIONS=2 ;;
        normal) ROTATIONS=3 ;;
        esac
        ;;

    bottom-up)
        case $ORIENTATION in
        right-up) ROTATIONS=1 ;;
        normal) ROTATIONS=2 ;;
        left-up) ROTATIONS=3 ;;
        esac
        ;;

    right-up)
        case $ORIENTATION in
        normal) ROTATIONS=1 ;;
        left-up) ROTATIONS=2 ;;
        bottom-up) ROTATIONS=3 ;;
        esac
        ;;
    esac

    while read -r MONITOR; do
        NAME="$(echo "$MONITOR" | jq '.name')"
        X="$(echo "$MONITOR" | jq '.x')"
        Y="$(echo "$MONITOR" | jq '.y')"

        COORDS="$(clockwise $X $Y $ROTATIONS)"
        X="$(echo "$COORDS" | awk '{print $1}')"
        Y="$(echo "$COORDS" | awk '{print $2}')"

        hyprctl --batch "keyword monitor $NAME, transform, $TRANSFORM"
    done < <(hyprctl monitors -j | jq -rac ".[]")

    notify-send -e Auto-Rotate "Monitors set to $*" -h string:key:auto-rotate
    hyprctl keyword input:touchdevice:transform "$TRANSFORM"
    hyprctl keyword input:tablet:transform "$TRANSFORM"

    LAST_ORIENTATION=$ORIENTATION
}

LAST_ORIENTATION=$(monitor-sensor --accel | stdbuf -oL grep orientation | stdbuf -oL cut -d : -f 2 | stdbuf -oL rev | stdbuf -oL cut -d , -f 2- | stdbuf -oL rev | stdbuf -oL sed 's/[ )]//g')

while read -r O; do
    rotate $O
done < <(monitor-sensor --accel | stdbuf -oL grep orientation | stdbuf -oL cut -d : -f 2 | stdbuf -oL rev | stdbuf -oL cut -d , -f 2- | stdbuf -oL rev | stdbuf -oL sed 's/[ )]//g')
