#!/usr/bin/env bash
set -euo pipefail

function rotate() {
    ORIENTATION="$1"
    LAST_ORIENTATION="$(cat "$2")"
    echo $ORIENTATION >"$2"

    if [[ -z $LAST_ORIENTATION ]] || [[ $ORIENTATION == "$LAST_ORIENTATION" ]]; then
        return
    fi

    if [[ "$ORIENTATION" == normal ]]; then
        TRANSFORM=0
    elif [[ "$ORIENTATION" == left-up ]]; then
        TRANSFORM=1
    elif [[ "$ORIENTATION" == bottom-up ]]; then
        TRANSFORM=2
    elif [[ "$ORIENTATION" == right-up ]]; then
        TRANSFORM=3
    fi

    while read -r MONITOR; do
        NAME="$(echo "$MONITOR" | jq -r '.name')"
        WIDTH="$(echo "$MONITOR" | jq '.width')"
        HEIGHT="$(echo "$MONITOR" | jq '.height')"
        REFRESH="$(echo "$MONITOR" | jq '.refreshRate')"
        SCALE="$(echo "$MONITOR" | jq '.scale')"
        X="$(echo "$MONITOR" | jq '.x')"
        Y="$(echo "$MONITOR" | jq '.y')"

        PLACEMENT=$(grep $NAME ~/.config/hypr/include/monitors.conf | grep -o 'auto\S*' | tr -d ,)

        case "$ORIENTATION" in
        left-up)
            case "$PLACEMENT" in
            auto | auto-right) PLACEMENT=auto-down ;;
            auto-down) PLACEMENT=auto-left ;;
            auto-left) PLACEMENT=auto-up ;;
            auto-up) PLACEMENT=auto-right ;;
            esac
            ;;

        bottom-up)
            case "$PLACEMENT" in
            auto | auto-right) PLACEMENT=auto-left ;;
            auto-down) PLACEMENT=auto-up ;;
            auto-left) PLACEMENT=auto-right ;;
            auto-up) PLACEMENT=auto-down ;;
            esac
            ;;

        right-up)
            case "$PLACEMENT" in
            auto | auto-right) PLACEMENT=auto-up ;;
            auto-down) PLACEMENT=auto-right ;;
            auto-left) PLACEMENT=auto-down ;;
            auto-up) PLACEMENT=auto-left ;;
            esac
            ;;
        esac

        if [[ $X -eq 0 && $Y -eq 0 ]]; then
            PLACEMENT=auto
        fi

        hyprctl --batch keyword monitor "$NAME, ${WIDTH}x${HEIGHT}@${REFRESH}, $PLACEMENT, $SCALE, transform, $TRANSFORM, bitdepth, 10" >/dev/null
    done < <(hyprctl monitors -j | jq -rc ".[]")

    notify-send -e Auto-Rotate "Monitors set to $ORIENTATION" -h string:key:auto-rotate
    hyprctl keyword input:touchdevice:transform "$TRANSFORM" >/dev/null
    hyprctl keyword input:tablet:transform "$TRANSFORM" >/dev/null
}

FILE="/tmp/${HYPRLAND_INSTANCE_SIGNATURE}_auto_rotate"

export -f rotate
monitor-sensor --accel | stdbuf -oL grep orientation | stdbuf -oL cut -d : -f 2 | stdbuf -oL rev | stdbuf -oL cut -d , -f 2- | stdbuf -oL rev | stdbuf -oL sed 's/[ )]//g' | xargs -I '{}' bash -c "rotate '{}' $FILE"
