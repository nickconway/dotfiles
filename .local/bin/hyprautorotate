#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

function rotate() {
    ORIENTATION="$1"

    case "$ORIENTATION" in
    normal)
        NEW_TRANSFORM=0
        ;;
    left-up)
        NEW_TRANSFORM=1
        ;;
    bottom-up)
        NEW_TRANSFORM=2
        ;;
    right-up)
        NEW_TRANSFORM=3
        ;;
    esac

    while read -r MONITOR; do
        NAME="$(echo "$MONITOR" | jq -r '.name')"
        WIDTH="$(echo "$MONITOR" | jq '.width')"
        HEIGHT="$(echo "$MONITOR" | jq '.height')"
        REFRESH="$(echo "$MONITOR" | jq '.refreshRate')"
        SCALE="$(echo "$MONITOR" | jq '.scale')"
        TRANSFORM="$(echo "$MONITOR" | jq '.transform')"
        X="$(echo "$MONITOR" | jq '.x')"
        Y="$(echo "$MONITOR" | jq '.y')"

        if [[ $NEW_TRANSFORM == "$TRANSFORM" ]]; then
            continue
        fi

        PLACEMENT=$(grep $NAME ~/.config/hypr/include/monitors.conf | grep -o 'auto\S*' | tr -d ,)

        case "$ORIENTATION" in
        left-up)
            case "$PLACEMENT" in
            auto | auto-right) PLACEMENT=auto-down ;;
            auto-down) PLACEMENT=auto-left ;;
            auto-left) PLACEMENT=auto-up ;;
            auto-up) PLACEMENT=auto-right ;;
            esac
            ;;

        bottom-up)
            case "$PLACEMENT" in
            auto | auto-right) PLACEMENT=auto-left ;;
            auto-down) PLACEMENT=auto-up ;;
            auto-left) PLACEMENT=auto-right ;;
            auto-up) PLACEMENT=auto-down ;;
            esac
            ;;

        right-up)
            case "$PLACEMENT" in
            auto | auto-right) PLACEMENT=auto-up ;;
            auto-down) PLACEMENT=auto-right ;;
            auto-left) PLACEMENT=auto-down ;;
            auto-up) PLACEMENT=auto-left ;;
            esac
            ;;
        esac

        if [[ $X -eq 0 && $Y -eq 0 ]]; then
            PLACEMENT=0x0
        fi

        hyprctl --batch keyword monitor "$NAME, ${WIDTH}x${HEIGHT}@${REFRESH}, $PLACEMENT, $SCALE, transform, $NEW_TRANSFORM, bitdepth, 10" >/dev/null
        notify-send -e Auto-Rotate "$NAME set to $ORIENTATION" -h string:synchronous:auto-rotate-$NAME
    done < <(hyprctl monitors -j | jq -rc ".[]")

    hyprctl keyword input:touchdevice:transform "$NEW_TRANSFORM" >/dev/null
    hyprctl keyword input:tablet:transform "$NEW_TRANSFORM" >/dev/null
}

export -f rotate
monitor-sensor --accel | stdbuf -oL grep orientation | stdbuf -oL cut -d : -f 2 | stdbuf -oL rev | stdbuf -oL cut -d , -f 2- | stdbuf -oL rev | stdbuf -oL sed 's/[ )]//g' | xargs -I '{}' bash -c "rotate '{}'"
