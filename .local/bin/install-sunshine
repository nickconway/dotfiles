#!/bin/bash
set -eou pipefail
set -x

yay -S --needed --noconfirm sunshine-git

echo 'KERNEL=="uinput", SUBSYSTEM=="misc", OPTIONS+="static_node=uinput", TAG+="uaccess"' | \
sudo tee /etc/udev/rules.d/60-sunshine.rules
sudo udevadm control --reload-rules
sudo udevadm trigger
sudo modprobe uinput

sudo setcap cap_sys_admin+p $(readlink -f $(which sunshine))

sudo bash -c "cat << EOF > /etc/systemd/user/sunshine.service
[Unit]
Description=Sunshine self-hosted game stream host for Moonlight.

[Service]
Environment=PULSE_SERVER=unix:$(pactl info | awk '/Server String/{print$3}')
ExecStart=$(which sunshine)
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=graphical-session.target
EOF"

systemctl --user daemon-reload
systemctl --user enable --now sunshine
