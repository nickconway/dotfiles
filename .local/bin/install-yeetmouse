#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

FORCE=false
if [[ "${1:-}" == "--force" ]]; then
    FORCE=true
fi

UNINSTALL=false
if [[ "${1:-}" == "--uninstall" ]]; then
    UNINSTALL=true
fi

YEETMOUSE_DIR="$HOME/.local/source/YeetMouse"

[[ -e ~/.config/yeetmouse/config.h ]]

if [[ ! -e "$YEETMOUSE_DIR" ]]; then
    git clone https://github.com/AndyFilter/YeetMouse "$YEETMOUSE_DIR"
fi

cd "$YEETMOUSE_DIR"
git pull
cp ~/.config/yeetmouse/config.h "$YEETMOUSE_DIR/driver"

if [[ "$FORCE" == true ]] || [[ "$UNINSTALL" == true ]]; then
    ./uninstall.sh
fi

if [[ "$UNINSTALL" != true ]]; then
    if ! grep -q yeetmouse <(lsmod) || [[ "$FORCE" == "true" ]]; then
        ./install.sh
    fi
fi
