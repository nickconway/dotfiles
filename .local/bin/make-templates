#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

if [[ -p /dev/stdin ]]; then
    readarray -t FILES
fi

FILES+=("${@}")

for f in "${FILES[@]}"; do
    if [[ ! -f "$f" ]] || [[ ! "$f" == *%%template* ]]; then
        continue
    fi

    new_file="${f/\%\%template*/}"

    echo "$f => $new_file:"
    envsubst <"$f" >"$new_file"
    echo
done
