#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

if [[ -p /dev/stdin ]]; then
    readarray -t FILES
fi

while read -r F; do
    FILES+=("$F")
done < <(fd --type f --hidden '\.template$' "${1:-.}")
shift || true

FILES+=("${@}")

for f in "${FILES[@]}"; do
    echo "$f => ${f%%.template}:"
    envsubst <"$f" | tee "${f%%.template}"
    echo
done
