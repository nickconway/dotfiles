#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

function apply() {
    cd "$1"

    if [[ -e setup ]]; then
        ./setup
    fi

    for f in *.yml; do
        kubectl apply -f <(envsubst <"$f")
    done
}

export -f apply

cd "${K8S_MANIFEST_DIR:-~/Kubernetes}"
CMD="$1"
shift

if [[ -p /dev/stdin ]]; then
    readarray -t TARGETS
elif [[ -n "$*" ]]; then
    TARGETS=("${@}")
else
    TARGETS=(*)
fi

run "$CMD \$D" "${TARGETS[@]}"
