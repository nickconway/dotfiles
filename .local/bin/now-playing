#!/usr/bin/env bash
set -euo pipefail

sleep .5
URL="$(playerctl metadata | rg Url | nth-to-end 3 | sed "s/size=300/size=80/")"

if pgrep -f "qs -c caelestia"; then
    TEXT="$(playerctl metadata -f "{{title}} - {{artist}}")"
else
    TEXT="$(playerctl metadata -f "{{title}}\n{{artist}}")"
fi

rm /tmp/now-playing-cover-* &>/dev/null || true

if [[ "$URL" == file://* ]]; then
    COVER_FILE="$URL"
else
    COVER_FILE="/tmp/now-playing-cover-$(playerctl metadata -f "{{title}}-{{artist}}").png"
    curl -s "$URL" --output "$COVER_FILE"
fi

if [[ $(playerctl status) == "Playing" ]]; then
    A="pause=󰏤"
else
    A="play=󰐊"
fi

(
    ACTION=$(notify-send "Now Playing" "$TEXT" -i "$COVER_FILE" -e -h string:synchronous:audio --action "prev=󰒮" --action "$A" --action "next=󰒭")

    if [[ -n "$ACTION" ]]; then
        playerctl "$ACTION"
        now-playing
    fi
) &
