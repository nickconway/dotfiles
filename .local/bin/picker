#!/usr/bin/env bash
set -euo pipefail

function pick() {
    if [[ -z "${LIST:-}" ]]; then
        return
    fi

    if [[ -t 0 ]]; then
        CMD=(fzft "${FZF_FLAGS[@]}")
    else
        CMD=(rofi "${ROFI_FLAGS[@]}")
    fi

    SELECTED="$("${CMD[@]}" <"$LIST")" && [[ -n "$SELECTED" ]] && echo -e "$SELECTED" | "${PROCESSING[@]}" | wl-copy -n && paste-keys
}

cd ~/.cache

ROFI_FLAGS=(
    -display-columns
    1
    -display-column-separator
    ' '
    -dmenu
    -config
    ~/.config/rofi/styles/style_2.rasi
    --placeholder-text
    '...'
    -i
    -p
    󰞅
    -theme-str
    'listview { columns: 6; } mode-switcher { enabled: false; } element-text { font: "NotoSans Nerd Font Propo 20"; }'
)

PROCESSING=(tee)

if [[ -p /dev/stdin ]]; then
    LIST=$(mktemp)
    ROFI_FLAGS=(-dmenu -p 󰲌 -i -config ~/.config/rofi/styles/style_2.rasi -theme-str 'listview { columns: 1; } mode-switcher { enabled: false; }')

    while read -r; do
        echo "$REPLY" >>"$LIST"
    done

    pick || true
    rm "$LIST"
    exit
fi

case ${1:-} in
clipboard)
    LIST=$(mktemp)
    cliphist list >$LIST

    FZF_FLAGS=(--preview="cliphist decode {}" -d $'\t' --with-nth 2 --prompt " > ")
    ROFI_FLAGS=(-dmenu -display-columns 2 -p  -i -config ~/.config/rofi/styles/style_2.rasi -theme-str 'listview { columns: 1; } mode-switcher { enabled: false; }')
    PROCESSING=(cliphist decode)
    ;;

color)
    color=$(hyprpicker -n -a)
    image=/tmp/${color}.png
    if [[ "$color" ]]; then
        magick -size 48x48 xc:"$color" ${image}
        notify-send -i ${image} "$color" "Copied to clipboard."
    fi
    ;;

emoji)
    if [[ ! -e emojis || "${2:-}" == "download" ]]; then
        echo "Downloading emojis..."
        curl -s https://raw.githubusercontent.com/muan/emojilib/main/dist/emoji-en-US.json |
            jq --raw-output '. | to_entries | .[] | .key + " " + (.value | join(" ") | sub("_"; " "; "g"))' \
                >emojis
    fi

    LIST=emojis
    FZF_FLAGS=(--border-label " Emojis " --prompt "󰞅 > ")
    PROCESSING=(awk '{print $1}')
    ;;

unicode)
    if [[ ! -e unicode || "${2:-}" == "download" ]]; then
        echo "Downloading unicode..."
        curl -s https://www.unicode.org/charts/charindex.html | htmlq '.subtle-nb > tbody > tr' -r 'th' |
            sed "s/<\/\?td>/ /g" | sed "s/<\/\?tr>/ /g" | awk 'NF' | sed "s/^[ \t]*//" | sed 's/<a href=\"\S*\">/\\U/' | sed "s/<\/a>//g" \
            >unicode-raw

        cat unicode-raw | while read -r LINE; do
            echo "$(echo -e "$LINE" | awk '{print $NF}') $LINE"
        done >unicode
    fi

    LIST=unicode
    FZF_FLAGS=(--preview "echo -e {} | awk '{print \$NF}'" --border-label " Unicode Symbols " --prompt "󰞅 > ")
    PROCESSING=(awk '{print $1}')
    ;;

icon)
    if [[ ! -e icons || "${2:-}" == "download" ]]; then
        echo "Downloading icons..."
        echo >icons

        sets=('all' 'cod' 'dev' 'fae' 'fa' 'iec' 'logos' 'oct' 'ple' 'pom' 'seti' 'weather' 'md')
        for set in "${sets[@]}"; do
            curl -s "https://raw.githubusercontent.com/ryanoasis/nerd-fonts/master/bin/scripts/lib/i_$set.sh" -o "i_$set.sh"

            if grep -q '^i=' i_$set.sh; then
                cat i_$set.sh | grep '^i=' | sed "s/=\$i//g" | sed "s/i='\(.*\)'/\1/p" >>icons
            fi
            rm i_$set.sh
        done
    fi

    LIST=icons
    FZF_FLAGS=(--border-label " Nerd Font Icons " --prompt "󰞅 > ")
    PROCESSING=(awk '{print $1}')
    ;;

password)
    rbw list --fields type,name,user | sed "s/\s\+/ /g" >passwords

    function get-rbw() {
        read -r INPUT
        TYPE=$(echo $INPUT | cut -d ' ' -f 1)
        QUERY=$(echo $INPUT | cut -d ' ' -f 2-)

        case $TYPE in
        Note) rbw get "$QUERY" ;;
        Login) rbw get $QUERY ;;
        *) echo "Unknown type" ;;
        esac
    }

    FZF_FLAGS=(--border-label " Passwords " --prompt "󱉼 > ")
    ROFI_FLAGS=(-dmenu -p 󱉼 -i -config ~/.config/rofi/styles/style_2.rasi -theme-str 'listview { columns: 1; } mode-switcher { enabled: false; }')
    PROCESSING=(get-rbw)
    LIST=passwords
    ;;
esac

pick
