#!/usr/bin/env bash
set -euo pipefail

NOTIFICATION_TITLE="$1"
TEXT="$2"
TERM_PROMPTS="$3"
NOTIFICATION_PROMPTS="$4"
DEFAULT_ACTION="$5"

IFS="," read -ra TERM_PROMPTS_ARR <<<"$TERM_PROMPTS"
IFS="," read -ra NOTIFICATION_PROMPTS_ARR <<<"$NOTIFICATION_PROMPTS"

function term() {
    while [[ -z "${EXIT:-}" ]]; do
        echo -n "$TEXT [${TERM_PROMPTS}] "
        read -r INPUT

        if [[ -z "$INPUT" ]]; then
            EXIT="$DEFAULT_ACTION"
        else
            for ((i = 0; i < ${#TERM_PROMPTS_ARR[@]}; i++)); do
                if [[ "$(echo "${TERM_PROMPTS_ARR[$i]}" | tr '[:upper:]' '[:lower:]')" == "$(echo "$INPUT" | tr '[:upper:]' '[:lower:]')" ]]; then
                    EXIT="$i"
                    break
                fi
            done
        fi
    done
}

function gui() {
    declare -a NOTIFICATION_PROMPTS_FLAGS=()
    for A in "${NOTIFICATION_PROMPTS_ARR[@]}"; do
        NOTIFICATION_PROMPTS_FLAGS+=("--action")
        NOTIFICATION_PROMPTS_FLAGS+=("$A")
    done

    EXIT="$(notify-send "$NOTIFICATION_TITLE" "$TEXT" "${NOTIFICATION_PROMPTS_FLAGS[@]}" -u critical)"
}

if [[ -n ${PROMPT_TERM:-} ]]; then
    term
elif [[ -n ${PROMPT_GUI:-} ]]; then
    gui
elif [[ -t 0 ]]; then
    term
elif [[ ! -t 0 ]]; then
    gui
fi

exit "${EXIT:-$DEFAULT_ACTION}"
