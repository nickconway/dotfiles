#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

if ! command -v rg >/dev/null; then
    echo "rg not found"
    return
fi

if [ $# -lt 2 ]; then
    echo "Recursive, interactive text replacement"
    echo "Usage: replace text replacement"
    return
fi

F=c

while getopts 'f' flag; do
    case "${flag}" in
    f)
        F=
        shift
        ;;
    *) continue ;;
    esac
done

FIND="$1"
REPLACE="$2"

shift
shift

read -ra FILES < <(rg --smart-case -l "$FIND" "${*:-.}" | xargs)

if [[ -n "${FILES:-}" ]] && [[ ${#FILES} -gt 0 ]]; then
    CMD=(
        AUTOSESSION_ENABLED=no
        nvim
        -c
        "':set nohlsearch | :argdo %s/$FIND/$REPLACE/g${F:-} | update'"
        -c
        qa
    )

    if [[ -n "$TMUX" ]]; then
        tmux display-popup -w 80% -h 80% -d $PWD -E "${CMD[*]} ${FILES[*]}"
    else
        eval "${CMD[@]}" "${FILES[@]}"
    fi

else
    echo Pattern not found
fi
