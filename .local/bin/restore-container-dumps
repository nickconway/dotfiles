#!/usr/bin/env bash
set -euo pipefail

docker ps --format {{.Names}} | grep "${1:-}" | grep -v nextcloud-aio | while read c; do
    DIR="$(docker inspect "$c" | jq -r '.[].Config.Labels["com.docker.compose.project.working_dir"]')"
    cd "$DIR"

    if docker exec "$c" bash -c 'which psql && [[ -n $POSTGRES_USER ]]' &>/dev/null; then
        echo "Restoring postgres container $c"
        docker exec -i "$c" bash -c 'psql -U "$POSTGRES_USER"' < data/dump.sql > /dev/null
    elif docker exec "$c" bash -c 'which mysql && [[ -n $MYSQL_USER ]]' &>/dev/null; then
        echo "Restoring mysql container $c"
        docker exec -i "$c" bash -c 'mysql -u "$MYSQL_USER" --password="$MYSQL_PASSWORD"' < data/dump.sql > /dev/null
    elif docker exec "$c" bash -c 'which mariadb && [[ -n $MARIADB_USER ]]' &>/dev/null; then
        echo "Restoring mariadb container $c"
        docker exec -i "$c" bash -c 'mariadb -u"$MARIADB_USER" -p"$MARIADB_PASSWORD"' < data/dump.sql > /dev/null
    elif docker exec "$c" bash -c 'which mongodump' &>/dev/null; then
        echo "Restoring mongo container $c"
        docker exec -i "$c" mongorestore --archive < data/mongo.dump > /dev/null
    fi
done
