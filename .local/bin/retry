#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

C=0
while [[ $C -lt 3 ]]; do
    if $*; then
        CODE=$?
        exit $CODE
    else
        CODE=$?
        if [[ $C -lt 2 ]] && [[ $CODE -ne 0 ]]; then
            sleep 3
        fi
    fi
    C=$((C + 1))
done

exit $CODE
