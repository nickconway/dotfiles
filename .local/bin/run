#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

shopt -s dotglob

cmd="$1"
shift

if [[ -p /dev/stdin ]]; then
    readarray -t DIRS
elif [[ -n "$*" ]]; then
    DIRS=("${@}")
else
    DIRS=(*)
fi

TMP=$(mktemp)

for D in "${DIRS[@]}"; do
    export D
    CMD=("$(echo "$cmd" | envsubst)")

    if command -v gum &>/dev/null; then
        CMD=(gum spin --title "$D" -- bash -c "{ ${CMD[@]}; } &> $TMP")
    else
        CMD=("(${CMD[@]}) &> $TMP")
    fi

    if ("${CMD[@]}"); then
        echo "✅ $D"
    else
        echo "❌ $D"

        if [[ -n "$(cat "$TMP")" ]]; then
            echo -----------------------------------------------------------
            echo
            cat "$TMP"
            echo
            echo -----------------------------------------------------------
        fi
    fi
done

rm "$TMP"
