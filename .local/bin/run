#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${DEBUG_MODE:-}" ]]; then
	set -x
fi

shopt -s dotglob

TMP=$(mktemp)

DIRS=(*)
if [[ -p /dev/stdin ]]; then
    readarray -t DIRS
fi

for D in "${DIRS[@]}"; do
    readarray -t CMD <<<"$@"
    export D

    if command -v gum &>/dev/null; then
        CMD=(gum spin --title "$D" -- bash -c "'{ ${CMD[@]}; } &> $TMP'")
    fi

    if (eval "${CMD[*]}"); then
        echo "✅ $D"
    else
        echo "❌ $D"

        if [[ -n "$(cat "$TMP")" ]]; then
            echo -----------------------------------------------------------
            echo
            cat "$TMP"
            echo
            echo -----------------------------------------------------------
        fi
    fi
done

rm "$TMP"
