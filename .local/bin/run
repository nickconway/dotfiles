#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

RED='\033[0;31m'
GREEN='\033[0;32m'
RESET='\033[0m'

shopt -s dotglob

CMD_INIT="$1"
shift

if [[ -p /dev/stdin ]]; then
    readarray -t TARGETS
elif [[ -n "$*" ]]; then
    TARGETS=("${@}")
else
    TARGETS=(*)
fi

TMP=$(mktemp)

for D in "${TARGETS[@]}"; do
    export D
    cmd=("$(envsubst <<<"$CMD_INIT")")

    if command -v gum &>/dev/null; then
        CMD=(gum spin --title "${cmd[@]}" -- bash -c "{ ${cmd[@]}; } &> $TMP")
    else
        CMD=("(${cmd[@]}) &> $TMP")
    fi

    if ("${CMD[@]}"); then
        echo -e "$GREEN$RESET ${cmd[*]}"
    else
        echo -e "$RED$RESET ${cmd[*]}"

        if [[ -n "$(cat "$TMP")" ]]; then
            echo -e $RED-----------------------------------------------------------$RESET
            echo
            cat "$TMP"
            echo
            echo -e $RED-----------------------------------------------------------$RESET
        fi
    fi
done

rm "$TMP"
