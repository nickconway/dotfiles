#!/bin/bash
set -euo pipefail

error() {
    notify-send "Screenshot" "An error occurred" -e
}
trap error ERR

mkdir -p "$(xdg-user-dir PICTURES)/Screenshots"
mkdir -p "$(xdg-user-dir DOCUMENTS)/OCR"
mkdir -p "$(xdg-user-dir VIDEOS)/Screen Recordings"

DATE="$(date +%Y-%m-%d_%H-%M-%S)"
IMG=$(xdg-user-dir PICTURES)/Screenshots/$(date +%Y-%m-%d_%H-%M-%S).png
TEXT="$(xdg-user-dir DOCUMENTS)/OCR/$DATE.txt"
OCR_IMG="$(xdg-user-dir DOCUMENTS)/OCR/$DATE.png"
VIDEO="$(xdg-user-dir VIDEOS)/Screen Recordings/$DATE.mkv"
case ${1:-} in
    '')
        REGION="$(slurp -c cba67f88 -b 00000099 -w 0 -B 00000099)"
        grim -g "$REGION" -l 0 $IMG
    ;;

    'ocr')
        REGION="$(slurp -c cba67f88 -b 00000099 -w 0 -B 00000099)"
        grim -g "$REGION" -l 0 $OCR_IMG
        tesseract "$IMG" - > "$TEXT"
        (
            ACTION=$(notify-send "Screenshot" "Text Saved and Copied to Clipboard" --action "open=Open" -e)
            [[ "$ACTION" == "open" ]] && xdg-open "$TEXT"
        ) &
    ;;

    'window')
        REGION="$(hyprctl clients -j \
            | jq -r '.[] | select(.workspace.id | tostring | test("'"$(echo $(hyprctl monitors -j | jq ".[].activeWorkspace.id") | sed "s/ /|/g")"'")) | "\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"' \
            | slurp -c cba67f88 -b 00000099 -w 0 -B 00000099)"
        grim -g "$REGION" -l 0 $IMG
    ;;

    'monitor')
        if [[ "$(hyprctl monitors -j | jq -r '.[] | .name' | wc -l)" == "1" ]]; then
            OUTPUT="$(hyprctl monitors -j | jq -r '.[] | .name')"
            sleep 0.5
            grim -o "$OUTPUT" -l 0 $IMG
        else
            REGION="$(slurp -o -c cba67f88 -b 00000099 -w 0 -B 00000099)"
            grim -g "$REGION" -l 0 $IMG
        fi
    ;;

    'record')
        if pidof wf-recorder &> /dev/null; then
            kill $(pidof wf-recorder)
            (
                ACTION=$(notify-send "Screen Recording" "Screen recording saved" -e --action "open=Open" -e)
                [[ "$ACTION" == "open" ]] && xdg-open "$(cat /tmp/wf-recorder-path)"
            ) &
            exit
        fi

        case ${2:-} in
            '')
                OUTPUT="$(hyprctl monitors -j | jq -r ".[] | select(.focused == true) | .name")"
                wf-recorder -a -f "$VIDEO" -o "$OUTPUT" &
                echo $VIDEO > /tmp/wf-recorder-path
                notify-send "Screen Recording" "Screen recording started" -e
            ;;

            'region')
                REGION="$(slurp -c cba67f88 -b 00000099 -w 0 -B 00000099)"
                wf-recorder -g "$REGION" -a -f "$VIDEO" &
                echo $VIDEO > /tmp/wf-recorder-path
                notify-send "Screen Recording" "Screen recording started" -e
            ;;
        esac
    ;;

esac

if [[ -e $IMG ]]; then
    wl-copy < $IMG
    (
        ACTION=$(notify-send -i "$IMG" "Screenshot" "Screenshot Saved and Copied to Clipboard" --action "open=Open" -e)
        [[ "$ACTION" == "open" ]] && xdg-open "$IMG"
    ) &
fi
