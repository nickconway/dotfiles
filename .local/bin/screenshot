#!/usr/bin/env bash
set -euo pipefail

function error() {
    notify-send "Screenshot" "An error occurred" -e
}

trap error ERR

function caelestia-pick() {
    FILE="/tmp/caelestia-picker-$(pgrep -f "qs -c caelestia")-coords"
    touch "$FILE"
    caelestia shell picker pick &>/dev/null
    inotifywait "$FILE" &>/dev/null

    if [[ ${1:-} == -r ]]; then
        echo "$(cat "$FILE" | cut -d ' ' -f 2)+$(cat "$FILE" | cut -d ' ' -f 1 | tr ',' +)"
        return
    fi

    cat "$FILE"
}

STOP_SCRIPT="$(which "$0-stopped")"

mkdir -p "$(xdg-user-dir PICTURES)/Screenshots"
mkdir -p "$(xdg-user-dir DOCUMENTS)/OCR"
mkdir -p "$(xdg-user-dir VIDEOS)/Screen Recordings"

DATE="$(date +%Y-%m-%d_%H-%M-%S)"
IMG="$(xdg-user-dir PICTURES)/Screenshots/$DATE.png"
IMG_EDIT="$(xdg-user-dir PICTURES)/Screenshots/$DATE-edit.png"
TEXT="$(xdg-user-dir DOCUMENTS)/OCR/$DATE.txt"
OCR_IMG="$(xdg-user-dir DOCUMENTS)/OCR/$DATE.png"
VIDEO="$(xdg-user-dir VIDEOS)/Screen Recordings/$DATE.mp4"

case ${1:-} in
'')
    REGION="$(caelestia-pick || slurp -c cba67f88 -b 00000099 -w 0 -B 00000099)"
    grim -g "$REGION" -l 0 $IMG
    ;;

'ocr')
    REGION="$(slurp -c cba67f88 -b 00000099 -w 0 -B 00000099)"
    grim -g "$REGION" -l 0 $OCR_IMG
    tesseract "$OCR_IMG" - >"$TEXT"
    head -c -1 <"$TEXT" | wl-copy
    (
        ACTION=$(notify-send -i "$OCR_IMG" "Screenshot" "Text Saved and Copied to Clipboard: $(cat "$TEXT")" --action "open=Open" -e)
        case $ACTION in
        'open') kitty xdg-open "$TEXT" ;;
        esac
    ) &
    ;;

'window')
    REGION="$(caelestia-pick || hyprctl clients -j |
        jq -r '.[] | select(.workspace.id | tostring | test("'"$(echo $(hyprctl monitors -j | jq ".[].activeWorkspace.id") | sed "s/ /|/g")"'")) | "\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"' |
        slurp -c cba67f88 -b 00000099 -w 0 -B 00000099)"
    grim -g "$REGION" -l 0 $IMG
    ;;

'monitor')
    OUTPUT="$(hyprctl monitors -j | jq -r ".[] | select(.focused == true) | .name")"
    sleep 0.5
    grim -o "$OUTPUT" -l 0 "$IMG"
    ;;

'record')
    if pidof gpu-screen-recorder &>/dev/null; then
        pkill -f --signal INT gpu-screen-recorder
        exit
    fi

    pactl load-module module-null-sink sink_name=Virtual-Speakers
    pactl load-module module-null-sink sink_name=Combined
    pactl load-module module-loopback sink=Virtual-Speakers source=@DEFAULT_SOURCE@.monitor
    pactl set-source-volume Virtual-Speakers.monitor 50%
    pactl load-module module-loopback sink=Combined source=Virtual-Speakers.monitor
    pactl load-module module-loopback sink=Combined source=@DEFAULT_SINK@

    FLAGS=(-f 60 -k hevc -a Combined.monitor -sc "$STOP_SCRIPT")

    case ${2:-} in
    '')
        OUTPUT="$(hyprctl monitors -j | jq -r ".[] | select(.focused == true) | .name")"
        FLAGS+=(-w "$OUTPUT")
        ;;

    'region')
        OUTPUT="$(caelestia-pick -r || slurp -c cba67f88 -b 00000099 -w 0 -B 00000099 -f "%wx%h+%x+%y")"
        FLAGS+=(-w region -region "$OUTPUT")
        ;;

    'window')
        OUTPUT="$(caelestia-pick -r || hyprctl clients -j |
            jq -r '.[] | select(.workspace.id | tostring | test("'"$(echo $(hyprctl monitors -j | jq ".[].activeWorkspace.id") | sed "s/ /|/g")"'")) | "\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"' |
            slurp -c cba67f88 -b 00000099 -w 0 -B 00000099 -f "%wx%h+%x+%y")"
        FLAGS+=(-w region -region "$OUTPUT")
        ;;
    esac

    gpu-screen-recorder -o "$VIDEO" "${FLAGS[@]}" &
    notify-send "Screen Recording" "Screen recording started" -e
    ;;

esac

if [[ -e $IMG ]]; then
    wl-copy <"$IMG"
    (
        ACTION=$(notify-send -i "$IMG" "Screenshot" "Screenshot Saved and Copied to Clipboard" --action "open=Open" --action "edit=Edit" -e)
        case $ACTION in
        "open") xdg-open "$IMG" ;;
        "edit") satty -f "$IMG" -o "$IMG_EDIT" --initial-tool brush --save-after-copy --disable-notifications --annotation-size-factor 0.5 ;;
        esac
    ) &
fi
