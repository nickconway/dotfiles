#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

function error() {
    notify-send "Screenshot" "An error occurred" -e
}

trap error ERR

function caelestia-pick() {
    if ! pgrep -afx "qs .*caelestia.*" &>/dev/null; then
        return 1
    fi

    FILE="/tmp/caelestia-picker-$(pgrep -afx "qs .*caelestia.*")-coords.*"
    touch "$FILE"
    qs -c caelestia ipc call picker pick &>/dev/null
    inotifywait "$FILE" &>/dev/null

    if [[ ${1:-} == -r ]]; then
        echo "$(cat "$FILE" | cut -d ' ' -f 2)+$(cat "$FILE" | cut -d ' ' -f 1 | tr ',' +)"
        return
    fi

    cat "$FILE"
}

function pick() {
    caelestia-pick
}

mkdir -p "$(xdg-user-dir PICTURES)/Screenshots"
mkdir -p "$(xdg-user-dir DOCUMENTS)/OCR"
mkdir -p "$(xdg-user-dir VIDEOS)/Screen Recordings"

DATE="$(date +%Y-%m-%d_%H-%M-%S)"
IMG="$(xdg-user-dir PICTURES)/Screenshots/$DATE.png"
IMG_EDIT="$(xdg-user-dir PICTURES)/Screenshots/$DATE-edit.png"
TEXT="$(xdg-user-dir DOCUMENTS)/OCR/$DATE.txt"
OCR_IMG="$(xdg-user-dir DOCUMENTS)/OCR/$DATE.png"

SLURP_CMD=(slurp -b "$(cat ~/.cache/wal/colors | sed '1q;d' | tr -d '#')bb" -c "$(cat ~/.cache/wal/colors | sed '4q;d' | tr -d '#')ff" -B "$(cat ~/.cache/wal/colors | sed '1q;d' | tr -d '#')bb" -d -w 1 -F "NotoSans")

case ${1:-} in
'')
    REGION="$(pick || "${SLURP_CMD[@]}")"
    grim -g "$REGION" -l 0 $IMG
    ;;

'ocr')
    REGION="$("${SLURP_CMD[@]}")"
    grim -g "$REGION" -l 0 $OCR_IMG
    tesseract "$OCR_IMG" - >"$TEXT"
    head -c -1 <"$TEXT" | wl-copy
    eval "$(notify-send -i "$OCR_IMG" "Screenshot" "Text Saved and Copied to Clipboard: $(cat "$TEXT")" --action "kitty xdg-open $TEXT=Open" -e)" &
    ;;

'window')
    WORKSPACES="$(
        (hyprctl monitors -j | jq ".[].activeWorkspace.id" | sed "s/ /|/g" && hyprctl monitors -j | jq ".[].specialWorkspace.id" | tr -d 0) | xargs | sed "s/ /|/g"
    )"
    REGION="$(pick || hyprctl clients -j |
        jq -r '.[] | select(.pinned), select(.workspace.id | tostring | test("'"$WORKSPACES"'")) | "\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"' |
        "${SLURP_CMD[@]}")"
    grim -g "$REGION" -l 0 $IMG
    ;;

'monitor')
    OUTPUT="$(hyprctl monitors -j | jq -r ".[] | select(.focused == true) | .name")"
    sleep 0.5
    grim -o "$OUTPUT" -l 0 "$IMG"
    ;;
esac

if [[ -e $IMG ]]; then
    wl-copy <"$IMG"
    eval "$(notify-send -i "$IMG" "Screenshot" "Screenshot Saved and Copied to Clipboard" --action "xdg-open $IMG=Open" --action "satty -f $IMG -o $IMG_EDIT --initial-tool brush --save-after-copy --disable-notifications --annotation-size-factor 0.5=Edit" -e)" &
fi
