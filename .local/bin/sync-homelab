#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

function clean() {
    COUNT=0
    until [[ -z ${HEALTHCHECK_ID:-} ]] || [[ $COUNT -gt 30 ]] || curl -f "https://health.$SERVICES_BASE_DOMAIN/ping/${HEALTHCHECK_TOKEN}/${HEALTHCHECK_ID}?create=1"; do
        sleep 5
        COUNT=$((COUNT + 1))
    done
}

while getopts "i:" arg; do
    case $arg in
    i) HEALTHCHECK_ID=$OPTARG ;;
    *) continue ;;
    esac
done
shift $((OPTIND - 1))

if [[ ! -e ~/Git/homelab ]]; then
    git clone https://github.com/nickconway/homelab ~/Git/homelab --recurse-submodules
    NEW=true
fi

cd ~/Git/homelab
git remote set-url origin https://github.com/nickconway/homelab
git remote set-url origin git@github.com:nickconway/homelab --push

OLD_HASH="$(git rev-parse HEAD)"
retry git pull
NEW_HASH="$(git rev-parse HEAD)"

if [[ ${NEW:-false} == false ]] && [[ "$OLD_HASH" == "$NEW_HASH" ]]; then
    clean
    exit
fi

echo

while read -r FILE; do
    APP="$(basename "$(dirname "$FILE")")"
    echo "$FILE -> $APP"
    if [[ -e "$DOCKER_STACK_DIR/$APP" ]]; then
        rsync -abhruvz --backup-dir ".rsync-backup" "docker/compose/$APP/" "$DOCKER_STACK_DIR/$APP"
        (
            cd "$DOCKER_STACK_DIR/$APP"
            docker compose up -d
        )
        echo
    fi
done < <(git diff --name-only "$OLD_HASH" "$NEW_HASH" | grep '^docker/compose/*')

clean
