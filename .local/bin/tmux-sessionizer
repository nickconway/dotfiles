#!/usr/bin/env bash

if [[ $# -eq 0 || $1 == "all" ]]; then
    command() (
        tmux list-sessions -F "#S" | grep -v $(tmux display-message -p '#S'); tmux display-message -p '#S'
        find "$([[ -e "$PROJECT_DIR" ]] && echo "$PROJECT_DIR")" -mindepth 1 -maxdepth 1 -type d
        zoxide query -l
    )
elif [[ $1 == "sessions" ]]; then
    command() (
        tmux list-sessions -F "#S"
    )
elif [[ $1 == "directories" ]]; then
    command() (
        find "$([[ -e "$PROJECT_DIR" ]] && echo "$PROJECT_DIR")" -mindepth 1 -maxdepth 1 -type d
        zoxide query -l
    )
fi

[[ $# -eq 1 ]] && command && exit

RENAME_SESSION_EXEC='bash -c '\'' printf >&2 "New name: "; read name; tmux rename-session -t {1} "${name}"; '\'''
RENAME_SESSION="ctrl-r:execute($RENAME_SESSION_EXEC)+reload(tmux-sessionizer sessions)"

export SELECTED=$(command | fzft --border-label="Tmux Sessionizer" \
    --prompt=" > " \
    --preview 'fzf-preview {}' \
    --header "ctrl-w =   ctrl-s = ǂ  ctrl-z =   ctrl-a = ∀  ctrl-t = 󰐆   ctrl-u =   crtl-d = " \
    --bind "ctrl-a:change-border-label(Tmux Sessionizer (All))+change-prompt( > )+reload(tmux-sessionizer all)" \
    --bind "ctrl-z:change-border-label(Tmux Sessionizer (Directories))+change-prompt( > )+reload(tmux-sessionizer directories)" \
    --bind "ctrl-w:change-border-label(Tmux Sessionizer (Windows))+change-prompt( > )+reload(tmux list-windows -a -F '#{session_name}:#{window_name}')" \
    --bind "$RENAME_SESSION" \
    --bind "ctrl-s:change-border-label(Tmux Sessionizer (Sessions))+change-prompt(ǂ > )+reload(tmux-sessionizer sessions)")

if [[ -z $SELECTED ]]; then
    exit 0
fi

for TMUXP_START_DIR in $SELECTED; do
    export SELECTED_FILE=$(basename "$TMUXP_START_DIR")
    export TMUXP_SESSION_NAME=$(basename "$TMUXP_START_DIR" | tr . _)

    export TMUX_RUNNING=$(pgrep tmux)

    if tmux has-session -t="$TMUXP_SESSION_NAME" 2> /dev/null; then
        tmux switch-client -t "$TMUXP_SESSION_NAME"
    elif [[ -e ~/.config/tmuxp/"$SELECTED_FILE".yaml ]]; then
        tmuxp load ~/.config/tmuxp/"$SELECTED_FILE".yaml -y > /dev/null
    elif [[ -z $TMUX ]] && [[ -z $TMUX_RUNNING ]]; then
        tmux new-session -s "$TMUXP_SESSION_NAME" -c "$TMUXP_START_DIR"
    else
        for F in ~/.config/tmuxp/*; do
            F="$(basename "$F")"
            if [[ -e "$TMUXP_START_DIR/${F%.*}" || -e "$TMUXP_START_DIR/.${F%.*}" ]]; then
                tmuxp load ~/.config/tmuxp/"$F" -y > /dev/null
                exit
            fi
        done
        tmux new-session -ds "$TMUXP_SESSION_NAME" -c "$TMUXP_START_DIR"
        tmux switch-client -t "$TMUXP_SESSION_NAME"
    fi
done
