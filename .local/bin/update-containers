#!/usr/bin/env bash
set -euo pipefail

if [[ -e "$DOCKER_STACK_DIR" ]]; then
    for d in "$DOCKER_STACK_DIR"/*; do
        cd $d
        echo $d
        if [[ -n *compose.y*ml ]]; then
            if [[ -n "$@" ]]; then
                UPDATE=
                for NAME in $@; do
                    for FILE in *compose.y*ml; do
                        if grep -q "$NAME" "$FILE"; then
                            UPDATE=true
                        fi
                    done
                done
            else
                UPDATE=true
            fi

            if [[ -z $UPDATE ]]; then
                continue
            fi

            if [[ -e /usr/bin/docker-compose ]]; then
                docker-compose pull
                docker-compose up -d --build
            else
                docker compose up -d --build --pull=always
            fi
        fi
    done
fi

docker image prune -af
