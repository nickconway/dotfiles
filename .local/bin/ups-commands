#!/usr/bin/env bash

echo "Monitoring UPS Status..."

while true; do
    COMMAND="$(journalctl -t ups -n0 -f | while read -r c; do
        echo $c | rev | cut -d ':' -f 1 | rev | xargs
        break
    done)"
    echo "$COMMAND"
    case "$COMMAND" in
    ONLINE)
        touch /tmp/ups-online
        notify-send "UPS Status" "UPS Switched to Main Power" -h string:synchronous:ups -e
        ;;
    ONBATT)
        (
            ACTION=$(notify-send "UPS Status" "UPS Switched to Battery Power" -h string:synchronous:ups -e --action "shutdown=Shutdown")
            case $ACTION in
            shutdown) [[ -e /tmp/ups-online ]] || sudo systemctl reboot -i ;;
            esac
        ) &
        ;;
    esac
done
