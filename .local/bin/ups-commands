#!/usr/bin/env bash

echo "Monitoring UPS Status..."

while true; do
    COMMAND="$(journalctl -t ups -n0 -f | while read -r c; do
        echo $c | rev | cut -d ':' -f 1 | rev | xargs
        break
    done)"
    echo "$COMMAND"
    case "$COMMAND" in
    ONLINE)
        touch /tmp/ups-online
        notify-send "UPS Status" "UPS Switched to Main Power" -h string:synchronous:ups -e
        ;;
    ONBATT)
        eval "$(notify-send "UPS Status" "UPS Switched to Battery Power" -h string:synchronous:ups -e -u critical --action "[[ -e /tmp/ups-online ]] || sudo systemctl reboot -i=Shutdown")" &
        ;;
    esac
done
