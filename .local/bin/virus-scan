#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

sudo freshclam

echo "Finding new files..."

if [[ -e .scan ]]; then
    sudo bash -c "find \"${1:-.}\" -type f -cnewer .scan > .files"
else
    sudo bash -c "find \"${1:-.}\" -type f > .files"
fi

echo "Scanning files..."

touch .scan
systemd-inhibit sudo clamscan -i --file-list .files 2>/dev/null >.scan-log || true
cat .scan-log

if grep -q "Infected files: [^0]" .scan-log; then
    notifiy-send "Virus Scan" "Infected files found" -u critical
    curl -fsSL -d "Infected files found" "https://notifications.$SERVICES_BASE_DOMAIN/notifications" -H "Authorization: Bearer ${NTFY_TOKEN}" &>/dev/null
fi
