#!/usr/bin/env bash
set -euo pipefail

FILE=/tmp/backlight-brightness
echo > $FILE

while true; do
    BRIGHTNESS=$(cat /sys/bus/iio/devices/iio:device*/in_illuminance_raw)
    if [[ $BRIGHTNESS -gt 2000 ]]; then
        LEVEL=off
    else
        LEVEL=high
    fi

    if [[ $LEVEL != $(cat $FILE) ]]; then
        sudo ~/.local/bin/keyboard_backlight "$LEVEL"
        echo "$LEVEL" > $FILE
    fi

    sleep 5
done
