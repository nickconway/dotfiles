#!/usr/bin/env bash
set -euo pipefail

function clean() {
    if [[ -e ~/Git/zmk-config/config/include/leader.dtsi.bkp ]]; then
        mv ~/Git/zmk-config/config/include/leader.dtsi{.bkp,}
    fi

    if [[ -e ~/Git/zmk-config/config/include/macros.dtsi.bkp ]]; then
        mv ~/Git/zmk-config/config/include/macros.dtsi{.bkp,}
    fi

    [[ -e ~/Git/zmk/app/.clangd ]] && rm ~/Git/zmk/app/.clangd

    if [[ -e ~/Git/zmk/tmp ]]; then
        if mountpoint -q ~/Git/zmk/tmp; then
            sudo umount ~/Git/zmk/tmp
        fi
        rmdir ~/Git/zmk/tmp
    fi
}

trap clean ERR EXIT

function run() {
    docker run \
        -v ~/Git/zmk:/workspace \
        -v ~/Git/zmk-config:/workspace/zmk-config \
        -v ~/Git/zmk/zephyr:/workspace/zephyr \
        -v ~/Git/zmk/modules:/workspace/modules \
        -v ~/Git/zmk/tools:/workspace/tools \
        -v ~/Git/zmk/app/build:/workspace/app/build \
        -w /workspace/app \
        --rm \
        zmk "$@"
}

function build() {
    board=
    snippet=
    flash=false
    log=false
    niceview=false
    pristine=false
    reset=false

    FLASH_FLAGS=()
    LOG_FLAGS=()

    while getopts 'b:flnoprs:' flag; do
        case "${flag}" in
        b) board=$OPTARG ;;
        f) flash=true ;;
        l) log=true ;;
        n)
            board=nice_nano
            niceview=true
            FLASH_FLAGS+=(-n)
            ;;
        o) LOG_FLAGS+=(-o) ;;
        p) pristine=true ;;
        s) LOG_FLAGS+=(-s "$OPTARG") ;;
        r)
            reset=true
            FLASH_FLAGS+=(-r)
            ;;
        *) continue ;;
        esac
    done
    shift $((OPTIND - 1))

    if [[ -e ~/Git/zmk-config/config/include/leader.dtsi ]]; then
        cp ~/Git/zmk-config/config/include/macros.dtsi{,.bkp}
        cp ~/Git/zmk-config/config/include/leader.dtsi{,.bkp}

        cat ~/.config/zmk/macros.dtsi >>~/Git/zmk-config/config/include/macros.dtsi

        (
            n=0
            while read line; do
                if [[ "$line" == '};' && $n = 0 ]]; then
                    cat ~/.config/zmk/leader.dtsi
                    n=1
                fi
                echo "$line"
            done <~/Git/zmk-config/config/include/leader.dtsi
        ) >~/Git/zmk-config/config/include/leader.dtsi.new

        mv ~/Git/zmk-config/config/include/leader.dtsi{.new,}
    fi

    cat <<EOF >~/Git/zmk/app/.clangd
        CompileFlags:
        Add: -Wno-unknown-warning-option
        Remove: [-m*, -f*]
EOF

    FLAGS=()
    FLAGS+=(-b "$board")

    if [[ $log == true ]]; then
        snippet=zmk-usb-logging
    fi

    if [[ -n $snippet ]]; then
        FLAGS+=(-S "$snippet")
    fi

    if [[ $pristine == true ]] ; then
        FLAGS+=(-p)
    fi

    OLD_BASE="${1:-}"

    BASE="$OLD_BASE"
    BASE="${BASE%_left}"
    BASE="${BASE%_right}"

    IS_SPLIT=false
    if [[ $(find ~/Git/zmk{,-config} -name ${BASE}_left.conf | wc -l) -gt 0 ]]; then
        IS_SPLIT=true
    fi

    CMAKE_BASE="-DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DZMK_CONFIG=/workspace/zmk-config/config"

    CMAKE_ARGS=()
    BUILD_DIRS=()
    SHIELDS=()

    if [[ "$IS_SPLIT" == true ]]; then
        if [[ "$OLD_BASE" == "$BASE" ]] || [[ "$OLD_BASE" == *"_left" ]]; then
            if [[ $niceview == true ]]; then
                CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD='${BASE}_left nice_view_adapter nice_view'")
                BUILD_DIRS+=("$BASE/nice-view/left")
            else
                CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD=${BASE}_left")
                BUILD_DIRS+=("$BASE/left")
            fi

            SHIELDS+=("${BASE}_left")
        fi

        if [[ "$OLD_BASE" == "$BASE" ]] || [[ "$OLD_BASE" == *"_right" ]]; then
            if [[ $niceview == true ]]; then
                CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD='${BASE}_right nice_view_adapter nice_view'")
                BUILD_DIRS+=("$BASE/nice-view/right")
            else
                CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD=${BASE}_right")
                BUILD_DIRS+=("$BASE/right")
            fi

            SHIELDS+=("${BASE}_right")
        fi
    else
        if [[ $niceview == true ]]; then
            CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD='${BASE} nice_view_adapter nice_view'")
            BUILD_DIRS+=("$BASE/nice-view")
        else
            CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD=${BASE}")
            BUILD_DIRS+=("$BASE")
        fi

        SHIELDS+=("$BASE")
    fi

    if [[ $reset == true ]]; then
        FLAGS=(-b nice_nano)
        CMAKE_ARGS=("-DSHIELD=settings_reset")
        BUILD_DIRS=("settings-reset")
    fi

    for ((index = 0; index < ${#BUILD_DIRS[@]}; index++)); do
        if ! grep "^CACHED_SNIPPET:STRING=$snippet$" "app/build/${BUILD_DIRS[$index]}/CMakeCache.txt" &>/dev/null; then
            PRISTINE=-p
        fi

        run west config build.cmake-args -- "${CMAKE_ARGS[$index]}"
        gum spin --title "Building ${SHIELDS[$index]}" -- bash -c "run west build ${FLAGS[*]} ${PRISTINE:-} -d build/${BUILD_DIRS[$index]}"
    done

    if [[ $flash == true ]]; then
        $0 flash "${FLASH_FLAGS[@]}" $*
    fi

    if [[ $log == true ]]; then
        $0 log "${LOG_FLAGS[@]}" $*
    fi
}

function wait-for-dev() {
    while [[ ! -e /dev/disk/by-label/NICENANO ]]; do
        true
    done
}

function wait-for-complete() {
    while [[ -e /dev/disk/by-label/NICENANO ]]; do
        true
    done
}

export -f run wait-for-dev wait-for-complete

function flash() {
    reset=false
    niceview=false

    while getopts ':nr' flag; do
        case "${flag}" in
        n) niceview=true ;;
        r) reset=true ;;
        *) continue ;;
        esac
    done
    shift $((OPTIND - 1))

    OLD_BASE="${1:-}"

    BASE="$OLD_BASE"
    BASE="${BASE%_left}"
    BASE="${BASE%_right}"

    IS_SPLIT=false
    if [[ $(find ~/Git/zmk{,-config} -name ${BASE}_left.conf | wc -l) -gt 0 ]]; then
        IS_SPLIT=true
    fi

    BUILD_DIRS=()
    SHIELDS=()

    if [[ "$IS_SPLIT" == true ]]; then
        if [[ "$OLD_BASE" == "$BASE" ]] || [[ "$OLD_BASE" == *"_right" ]]; then
            BUILD_DIRS+=("$BASE/right")
            SHIELDS+=("${BASE}_right")
        fi

        if [[ "$OLD_BASE" == "$BASE" ]] || [[ "$OLD_BASE" == *"_left" ]]; then
            BUILD_DIRS+=("$BASE/left")
            SHIELDS+=("${BASE}_left")
        fi
    else
        BUILD_DIRS+=("$BASE")
        SHIELDS+=("$BASE")
    fi

    if [[ $reset == true ]]; then
        length=${#BUILD_DIRS[@]}

        FLAGS=(-b nice_nano)
        BUILD_DIRS=()
        SHIELDS=()

        for ((index = 0; index < length; index++)); do
            BUILD_DIRS+=("settings-reset")
            SHIELDS+=(settings_reset)
        done
    fi

    for ((index = 0; index < ${#BUILD_DIRS[@]}; index++)); do
        mkdir -p ~/Git/zmk/tmp

        gum spin --title "Set ${SHIELDS[$index]} to flashing mode..." -- bash -c wait-for-dev

        sudo mount /dev/disk/by-label/NICENANO ~/Git/zmk/tmp
        sudo cp ~/Git/zmk/app/build/${BUILD_DIRS[$index]}/zephyr/zmk.uf2 ~/Git/zmk/tmp

        gum spin --title "Flashing ${SHIELDS[$index]}..." -- bash -c wait-for-complete

        clean
    done
}

function log() {
    search=""
    passthrough=false

    while getopts 'os:' flag; do
        case "${flag}" in
        o) passthrough=true ;;
        s) search="$OPTARG" ;;
        *) continue ;;
        esac
    done
    shift $((OPTIND - 1))

    RG_FLAGS=(-i)

    if [[ -n "$search" ]]; then
        RG_FLAGS+=("$search")
        if [[ "$passthrough" == true ]]; then
            RG_FLAGS+=("--passthrough")
        fi

        (sudo tio /dev/ttyACM0) </dev/tty | rg "${RG_FLAGS[@]}"
    else
        (sudo tio /dev/ttyACM0) </dev/tty
    fi
}

function test() {
    verbose=false

    while getopts 'v' flag; do
        case "${flag}" in
        v) verbose=true ;;
        *) continue ;;
        esac
    done
    shift $((OPTIND - 1))

    ARGS=""

    if [[ $verbose == true ]]; then
        ARGS="ZMK_TESTS_VERBOSE=y"
    fi

    run bash -xc "$ARGS west test tests/${1:-}"
}

function update() {
    run bash -c "west update"
}

if ! docker image inspect zmk &>/dev/null; then
    docker build -t zmk ~/Git/zmk/.devcontainer
fi

if [[ ! -e ~/Git/zmk/.west ]]; then
    run bash -c "west init -l ."
    update
fi

$*
