#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${LOG:-}" ]]; then
    exec &>"/tmp/$(basename "$0").log"
    set -x
fi

if [[ -n "${DEBUG_MODE:-}" ]]; then
    set -x
fi

function clean() {
    if [[ -e "$ZMK_CONFIG_DIR"/config/include/leader.dtsi.bkp ]]; then
        mv "$ZMK_CONFIG_DIR"/config/include/leader.dtsi{.bkp,}
    fi

    if [[ -e "$ZMK_CONFIG_DIR"/config/include/macros.dtsi.bkp ]]; then
        mv "$ZMK_CONFIG_DIR"/config/include/macros.dtsi{.bkp,}
    fi

    [[ -e app/.clangd ]] && rm app/.clangd

    if [[ -e tmp ]]; then
        if mountpoint -q tmp; then
            sudo umount tmp
        fi
        rmdir tmp
    fi
}

trap clean ERR EXIT

CMAKE_BASE="-DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DZMK_CONFIG=/config/config"

if [[ -e "$ZMK_CONFIG_DIR/extra-modules" ]]; then
    CMAKE_BASE+=" -DZMK_EXTRA_MODULES=$(ls "$ZMK_CONFIG_DIR"/extra-modules | while read -r M; do echo /config/extra-modules/$M; done | xargs | sed 's/ /,/g')"
fi

cd "$ZMK_DIR"

function run() {
    docker run \
        -v "${ZMK_DIR}":/workspace \
        -v "${ZMK_CONFIG_DIR}":/config \
        -w /workspace/app \
        --rm \
        zmk "$@"
}

function get-dirs() {
    OLD_BASE="${1:-}"

    BASE="$OLD_BASE"
    BASE="${BASE%_left}"
    BASE="${BASE%_right}"

    CMAKE_ARGS=()
    BUILD_DIRS=()
    SHIELDS=()

    IS_SPLIT=false
    if [[ $(find "$ZMK_DIR" "$ZMK_CONFIG_DIR" -name ${BASE}_left.conf | wc -l) -gt 0 ]]; then
        IS_SPLIT=true
    fi

    if [[ "$IS_SPLIT" == true ]]; then
        if [[ "$OLD_BASE" == "$BASE" ]] || [[ "$OLD_BASE" == *"_left" ]]; then
            if [[ $niceview == true ]]; then
                CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD='${BASE}_left nice_view_adapter nice_view${niceview_ext:+_$niceview_ext}'")
                BUILD_DIRS+=("$BASE/nice-view${niceview_ext:+-$niceview_ext}/left")
            else
                CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD=${BASE}_left")
                BUILD_DIRS+=("$BASE/left")
            fi

            SHIELDS+=("${BASE}_left")
        fi

        if [[ "$OLD_BASE" == "$BASE" ]] || [[ "$OLD_BASE" == *"_right" ]]; then
            if [[ $niceview == true ]]; then
                CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD='${BASE}_right nice_view_adapter nice_view${niceview_ext:+_$niceview_ext}'")
                BUILD_DIRS+=("$BASE/nice-view${niceview_ext:+-$niceview_ext}/right")
            else
                CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD=${BASE}_right")
                BUILD_DIRS+=("$BASE/right")
            fi

            SHIELDS+=("${BASE}_right")
        fi
    else
        if [[ $niceview == true ]]; then
            CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD='${BASE} nice_view_adapter nice_view${niceview_ext:+_$niceview_ext}'")
            BUILD_DIRS+=("$BASE/nice-view${niceview_ext:+-$niceview_ext}")
        else
            CMAKE_ARGS+=("$CMAKE_BASE -DSHIELD=${BASE}")
            BUILD_DIRS+=("$BASE")
        fi

        SHIELDS+=("$BASE")
    fi

    if [[ $reset == true ]]; then
        BUILD_FLAGS=(-b nice_nano)
        CMAKE_ARGS=("-DSHIELD=settings_reset")

        length=${#BUILD_DIRS[@]}
        BUILD_DIRS=()
        for ((index = 0; index < length; index++)); do
            BUILD_DIRS+=("settings-reset")
        done
    fi
}

function build() {
    if [[ -e "$ZMK_CONFIG_DIR"/config/include/leader.dtsi ]]; then
        cp "$ZMK_CONFIG_DIR"/config/include/leader.dtsi{,.bkp}
        cp "$ZMK_CONFIG_DIR"/config/include/macros.dtsi{,.bkp}

        cat ~/.config/zmk/leader.dtsi >>"$ZMK_CONFIG_DIR"/config/include/leader.dtsi
        cat ~/.config/zmk/macros.dtsi >>"$ZMK_CONFIG_DIR"/config/include/macros.dtsi
    fi

    cat <<EOF >app/.clangd
        CompileFlags:
        Add: -Wno-unknown-warning-option
        Remove: [-m*, -f*]
EOF

    get-dirs "$@"

    for ((index = 0; index < ${#BUILD_DIRS[@]}; index++)); do
        if ! grep "^CACHED_SNIPPET:STRING=$snippet$" "app/build/${BUILD_DIRS[$index]}/CMakeCache.txt" &>/dev/null; then
            BUILD_FLAGS+=(-p)
        fi

        run west config build.cmake-args -- "${CMAKE_ARGS[$index]}"
        gum spin --title "Building ${SHIELDS[$index]}" -- bash -c "run west build ${BUILD_FLAGS[*]} -d build/${BUILD_DIRS[$index]}"
    done

    if [[ $flash == true ]]; then
        flash "$@"
    fi

    if [[ $log == true ]]; then
        log "$@"
    fi
}

function wait-for-dev() {
    while [[ ! -e /dev/disk/by-label/NICENANO ]]; do
        true
    done
}

function wait-for-complete() {
    while [[ -e /dev/disk/by-label/NICENANO ]]; do
        true
    done
}

export -f run wait-for-dev wait-for-complete

function flash() {
    get-dirs "$@"

    for ((index = $((${#BUILD_DIRS[@]} - 1)); index >= 0; index--)); do
        mkdir tmp

        gum spin --title "Set ${SHIELDS[$index]} to flashing mode..." -- bash -c wait-for-dev

        sudo mount /dev/disk/by-label/NICENANO tmp
        sudo cp app/build/${BUILD_DIRS[$index]}/zephyr/zmk.uf2 tmp

        gum spin --title "Flashing ${SHIELDS[$index]}..." -- bash -c wait-for-complete

        clean
    done
}

function log() {
    if [[ -n "$search" ]]; then
        if [[ "$passthrough" == true ]]; then
            RG_FLAGS+=("--passthrough")
        fi

        (sudo tio /dev/ttyACM0) </dev/tty | rg "${RG_FLAGS[@]}"
    else
        (sudo tio /dev/ttyACM0) </dev/tty
    fi
}

function test() {
    run bash -xc "${TEST_ARGS[*]} west test tests/${1:-}"
}

function update() {
    run bash -c "cd ${1:-.} && west update --fetch-opt=--filter=tree:0 && west zephyr-export"
}

snippet=
flash=false
log=false
niceview=false
reset=false
search=
passthrough=false

BUILD_FLAGS=()
TEST_ARGS=()

while getopts ':b:fglnoprs:v' flag; do
    case "${flag}" in
    b) board="${OPTARG:-nice_nano}" ;;
    f) flash=true ;;
    l)
        BUILD_FLAGS+=(-S zmk-usb-logging)
        log=true
        ;;
    n)
        eval "$(get-opt-arg $OPTIND "$@")"
        niceview=true
        niceview_ext=$OPTARG
        ;;
    o) RG_FLAGS+=(--passthrough) ;;
    p) BUILD_FLAGS+=(-p) ;;
    s) RG_FLAGS+=(-i "$OPTARG") ;;
    r) reset=true ;;
    v) TEST_ARGS+=("ZMK_TESTS_VERBOSE=y") ;;
    *) continue ;;
    esac
done
shift $((OPTIND - 1))

BUILD_FLAGS+=(-b "${board:-nice_nano}")

if ! docker image inspect zmk &>/dev/null; then
    docker build -t .devcontainer
fi

if [[ ! -e .west ]]; then
    run bash -c "west init -l ."
    update
fi

if [[ ! -e "$ZMK_CONFIG_DIR"/.west ]]; then
    run bash -c "cd /config/config && west init -l ."
    update /config/config
fi

$*
